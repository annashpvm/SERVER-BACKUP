/*global Ext*/
Ext.onReady(function () {
    Ext.QuickTips.init();
    var gstFlag;
   var GinUser = localStorage.getItem('ginusername');
   var GinUserid = localStorage.getItem('ginuserid');
   var GinUserType = localStorage.getItem('ginusertype');

    var GinFinid = localStorage.getItem('ginfinid');
    var gstfinyear = localStorage.getItem('gstyear');
    var GinCompcode = localStorage.getItem('gincompcode');

   var  invfin = localStorage.getItem('invfin');

    var editfind = 0;
  // var GinUser = localStorage.getItem('gstuser');
  // var GinUserid = localStorage.getItem('ginuser');

   var finstdate = localStorage.getItem('gfinstdate');   
   var finenddate = localStorage.getItem('gfineddate');  

   var GinNewDays = Number(localStorage.getItem('newdays'));
   var GinEditDays = Number(localStorage.getItem('editdays'));
    var rounding = 0;
    var cdtaxval = 0;
    var crnoteseqno = 0;
    var gstrcpttype;
    var gstPaytype;
    var totadjamtvalue;
    var gstbillnos;
    var narra;
    var totalval;
    var desc;
    var date;
    var dgadjrecord = Ext.data.Record.create([]);
    var fm = Ext.form;
    var dgaccrecord = Ext.data.Record.create([]);
    var dgrecord = Ext.data.Record.create([]);
    var dgrecord2 = Ext.data.Record.create([]);

    var fromdate;
    var todate;
    var ledgercode = 0;
    var partycode = 0;
    var accledgercode = 0;

    var quality = '';

    var invnolist = '';
    var ledtype ="G";

    var seqno = 0;
    var editrow = 0; 
    var editrow2 = 0; 
  
    var gridedit = "false";

    var ECreditNote = "N";

    var salledcode = 0;  var cgstledcode = 0; var sgstledcode = 0; var igstledcode = 0;
    var salledname = '';  var cgstledname = '';  var sgstledname = '';  var igstledname = '';

    var cdpermt = 0;
    var ratediffmt = 0;
    var totinvwt = 0;

    var lblAcctname = new Ext.form.Label({
        fieldLabel  : 'Account Name',
        id          : 'lblAcctname',
        width       : 70,
      labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });
   

 var billnolist = '';

    var lblType = new Ext.form.Label({
        fieldLabel  : 'Type',
        id          : 'lblType',
        width       : 50,
      labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });
    
    
    var lblDebit = new Ext.form.Label({
        fieldLabel  : 'Debit',
        id          : 'lblDebit',
        width       : 70,
      labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
  
    });
    
    var txtDebit = new Ext.form.NumberField({
        fieldLabel  : '',
        id          : 'txtDebit',
        width       : 90,
        name        : 'debit',
        enableKeyEvents: true,
        listeners:{
          specialkey:function(f,e){
             if (e.getKey() == e.ENTER)
             { 
                 btnSubmit.focus();
             }
          }
        } 
    });
    
    var lblCredit = new Ext.form.Label({
        fieldLabel  : 'Credit',
        id          : 'lblCredit',
        width       : 70,
      labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",

    });
    
    
    var txtQty = new Ext.form.NumberField({
        fieldLabel  : 'Qty',
        id          : 'txtQty',
        width       : 90,
        name        : 'txtQty',
        readOnly : 'true',
        decimalPrecision: 3,
        labelStyle : "font-size:14px;font-weight:bold;color:#0080ff",
	style: {
		    'color':'#900C3F ',readOnly:true,'text-align': 'right',
		    'style': 'Helvetica',
		    'font-size': '14px','font-weight':'bold'
		},
        enableKeyEvents: true,
        listeners:{

        } 
    });

    var txtCredit = new Ext.form.NumberField({
        fieldLabel  : '',
        id          : 'txtCredit',
        width       : 90,
        name        : 'credit',
        enableKeyEvents: true,
        listeners:{
          specialkey:function(f,e){
             if (e.getKey() == e.ENTER)
             { 
                 btnSubmit.focus();
             }
          }
        } 
    });

 var loadECNStatus = new Ext.data.Store({
      id: 'loadECNStatus',
//      autoLoad : true,
      proxy: new Ext.data.HttpProxy({
                url: 'clsBankReceipt.php',      // File to connect to
                method: 'POST'
            }),
            baseParams:{task:"check_e_credit_note_status"}, // this parameter asks for listing
      reader: new Ext.data.JsonReader({
                  // we tell the datastore where to get his data from
        root: 'results',
        totalProperty: 'total',
        id: 'id'
      },[
          'E_inv_confirm'
      ]),
    });


 var loadInvVarietyDatastore = new Ext.data.Store({
      id: 'loadInvVarietyDatastore',
//      autoLoad : true,
      proxy: new Ext.data.HttpProxy({
                url: 'clsBankReceipt.php',      // File to connect to
                method: 'POST'
            }),
            baseParams:{task:"loadInvoiceVarity"}, // this parameter asks for listing
      reader: new Ext.data.JsonReader({
                  // we tell the datastore where to get his data from
        root: 'results',
        totalProperty: 'total',
        id: 'id'
      },[
          'vargrp_type_name'
      ]),
    });


 var loadLedgerListDatastore = new Ext.data.Store({
      id: 'loadLedgerListDatastore',
//      autoLoad : true,
      proxy: new Ext.data.HttpProxy({
                url: 'clsBankReceipt.php',      // File to connect to
                method: 'POST'
            }),
            baseParams:{task:"loadLedgerlist"}, // this parameter asks for listing
      reader: new Ext.data.JsonReader({
                  // we tell the datastore where to get his data from
        root: 'results',
        totalProperty: 'total',
        id: 'id'
      },[
          'cust_code', 'cust_name','led_type'
      ]),
    });


 var loadSearchLedgerListDatastore = new Ext.data.Store({
      id: 'loadSearchLedgerListDatastore',
//      autoLoad : true,
      proxy: new Ext.data.HttpProxy({
                url: 'clsBankReceipt.php',      // File to connect to
                method: 'POST'
            }),
            baseParams:{task:"loadSearchLedgerlist"}, // this parameter asks for listing
      reader: new Ext.data.JsonReader({
                  // we tell the datastore where to get his data from
        root: 'results',
        totalProperty: 'total',
        id: 'id'
      },[
          'cust_code', 'cust_ref','cust_type'
      ]),
    });


function getCNRemarks()
{
/*
        if (ratediffmt > 0)
           Remarks = "BEING THE AMOUNT CREDITED TO YOUR ACCOUNT TOWARDS CASH DISCOUNT Rs." + cdpermt + "/MT AND RATE DIFFERENCE Rs." + ratediffmt + "/MT AGAINST INV. NO(s) ";
        else
           Remarks = "BEING THE AMOUNT CREDITED TO YOUR ACCOUNT TOWARDS CASH DISCOUNT Rs." + cdpermt + "/MT AGAINST INV. NO(s) ";
*/




        flxAdjustDetails.getSelectionModel().selectAll();
        var selrows = flxAdjustDetails.getSelectionModel().getCount();
        var sel = flxAdjustDetails.getSelectionModel().getSelections();
        gstbillnos = "";
        narra = '';
        totinvwt = 0;
	
        var getinvno = '';  
       billnolist = '';

        for (var i = 0; i < selrows; i++) {

            if (Number(sel[i].data.cdamount) > 0 && Number(sel[i].data.adjamt) > 0 ) {


                gstbillnos = gstbillnos + sel[i].data.invno + ",";
                totinvwt = Number(totinvwt)+ Number(sel[i].data.invwt);
                if (sel[i].data.invno.substring(0,3)  == "TN/" || sel[i].data.invno.substring(0,3)  == "OS/")
                { 
                   getinvno = sel[i].data.invno;
			if (billnolist == '')
			   billnolist +=  sel[i].data.invno;
			else
			   billnolist +=  ',' + sel[i].data.invno.substring(0,7); 
                }
            }
        }

        quality  = '';
        loadInvVarietyDatastore.removeAll();
        loadInvVarietyDatastore.load({
            url: 'clsBankReceipt.php',
            params:
                    {
                        task  :"loadInvoiceVarity",
                        compcode : GinCompcode,
                        invno : getinvno,   
                  
                    },
                     callback : function() {  
         	var cnt = loadInvVarietyDatastore.getCount();
                if (cnt > 0)
                {
                     quality  = loadInvVarietyDatastore.getAt(0).get('vargrp_type_name');   

                } 

                     }
        });




        totinvwt =  Ext.util.Format.number(totinvwt,'0.000');

        txtQty.setRawValue(totinvwt);

   //     txtRefBills.setRawValue(gstbillnos);

        var totcd_pmt =   Number(cdpermt) + Number(ratediffmt);

//        txtCNRemarks.setRawValue(Remarks+ gstbillnos+ 'Qty : ' + totinvwt + ' MTS * ' + totcd_pmt  + ' + GST = CD AMOUNT : ' + txtTotCDAmt.getRawValue()+'/-' );



     //      Remarks = "BEING THE AMOUNT CREDITED TO YOUR ACCOUNT TOWARDS CASH DISCOUNT Rs." + cdpermt + "/MT AGAINST INV. NO(s) ";

/*
        flxCD.getSelectionModel().selectAll();
        var selrows = flxCD.getSelectionModel().getCount();
        var sel = flxCD.getSelectionModel().getSelections();
        gstbillnos = "";
 
        for (var i = 0; i < selrows; i++) {

            if (Number(sel[i].data.qty) > 0 && Number(sel[i].data.CDValue) > 0 ) {
                gstbillnos = gstbillnos + 'FOR INV NO(S) ' +  sel[i].data.invno;

                gstbillnos = gstbillnos + 'CASH DISCOUNT : ' +  sel[i].data.cdpmt;
                if (Number(sel[i].data.ratediff) > 0)
                   gstbillnos = gstbillnos + 'RATE DIFF : ' +  sel[i].data.ratediff;

                gstbillnos = gstbillnos + 'QTY : ' +  sel[i].data.qty;
                gstbillnos = gstbillnos + 'VALUE : ' +  sel[i].data.CDValue;

            }
        }


         txtCNRemarks.setRawValue("BEING THE AMOUNT CREDITED TO YOUR ACCOUNT TOWARDS " + gstbillnos );

*/
     //       flxCD.getSelectionModel().selectAll();
//            const selCD = flxCD.getSelectionModel().getSelections();

var allRows = flxCD.getStore().getRange();

var gstbillnos = '';

for (var i = 0; i < allRows.length; i++) {
    var row = allRows[i].data;
    if (Number(row.qty) > 0 && Number(row.CDValue) > 0) {
        gstbillnos += 'FOR INV NO(S) : ' + row.invno + ': ';
        gstbillnos += 'CASH DISCOUNT: Rs.' + row.cdpmt + '/MT, ';
        if (Number(row.ratediff) > 0) {
            gstbillnos += 'RATE DIFF: Rs.' + row.ratediff + '/MT, ';
        }
        gstbillnos += 'QTY: ' + row.qty + ' MTS, ';
        gstbillnos += 'VALUE: Rs.' + row.CDValue + '/- ';


   
    }
}

gstbillnos =  gstbillnos + " + GST  Total CD Amount : " + Ext.util.Format.number(txtTotCDAmt.getRawValue(),"0.00") +'/-';

txtCNRemarks.setRawValue("BEING THE AMOUNT CREDITED TO YOUR ACCOUNT TOWARDS " + gstbillnos);
        


}

var btnConfirm	 = new Ext.Button({
    style   : 'text-align:center;',
    text    : "Confirm",
    width   : 60,
    height  : 30,
          border: 1,
          style: {
              borderColor: 'blue',
              borderStyle: 'solid',
              fontSize  : '14px',

          },
    bodyStyle:{"background-color":"#ebebdf"},
    listeners:{
        click: function(){     

               loadCDDetails();

        }
    }
}); 


var btnRemarks	 = new Ext.Button({
    style   : 'text-align:center;',
    text    : "GET Credi Note-Remarks",
    width   : 60,
    height  : 30,
          border: 1,
          style: {
              borderColor: 'blue',
              borderStyle: 'solid',
              fontSize  : '14px',

          },
    bodyStyle:{"background-color":"#ebebdf"},
    listeners:{
        click: function(){     

               getCNRemarks();

        }
    }
});  


    var btnSubmit = new Ext.Button({
        style   : 'text-align:center;',
        text    : "Submit",
        width   : 60,
        x       : 850,
        y       : 95,
          border: 1,
          style: {
              borderColor: 'blue',
              borderStyle: 'solid',
              fontSize  : '14px',

          },
        listeners: {
            click: function(){
     	        flxAccounts.getSelectionModel().selectAll();

	        var selrows = flxAccounts.getSelectionModel().getCount();
	        var sel = flxAccounts.getSelectionModel().getSelections();
			var idx = flxAccounts.getStore().indexOf(editrow2);
               		sel[idx].set('ledname' , cmbAccountName.getRawValue());
			sel[idx].set('debit'   , Number(txtDebit.getRawValue()));
	 		sel[idx].set('credit'   , Number(txtCredit.getRawValue()));
                        sel[idx].set('ledcode'  , cmbAccountName.getValue());
			sel[idx].set('ledtype' , ledtype);
			flxDetail.getSelectionModel().clearSelections();

           grid_tot_acc();
            }
        }
    });

   function cmbtypechange()
   {

        if (cmbType.getValue()==1){
            txtDebit.enable();
            Ext.getCmp('txtDebit').focus(true, 1);
            txtCredit.disable();
            txtCredit.setValue("");
	    txtDebit.setValue("");	
        }else if (cmbType.getValue()==2){
            txtDebit.disable();
            txtCredit.enable();
            Ext.getCmp('txtCredit').focus(true, 1);
	    txtCredit.setValue("");	
            txtDebit.setValue("");
        }else{
            txtDebit.disable();
            txtCredit.disable();
            txtDebit.setValue("");
            txtCredit.setValue("");
        }

   }


    var cmbType = new Ext.form.ComboBox({
        fieldLabel      : '',
        width           : 70,
        displayField    : 'type_name',
        valueField      : 'type_code',
        hiddenName      : 'type_name',
        id              : 'cmbType',
        typeAhead       : true,
        mode            : 'local',
        forceSelection  : false,
        triggerAction   : 'all',
        selectOnFocus   : false,
        editable        : true,
        allowblank      : false,
        store           : [['1','Dr'],['2','Cr']],
        listeners: {
          specialkey:function(f,e){
             if (e.getKey() == e.ENTER)
             {
            Ext.getCmp('txtDebit').focus(true, 1);
             }
          },

            blur: function(){
                   cmbtypechange();
            },
            change: function(){
                   cmbtypechange();
            },
            select : function(){
                   cmbtypechange();
            }
        }
    });
    

new Ext.KeyMap( Ext.getBody(), [{
            key: "s",
            ctrl:true,
            fn: function( e, ele ){
                ele.preventDefault();
                if (gstFlag == "Edit")
                {

		Ext.Msg.prompt('Reason for Modification', '', function(btn, text){
		    if (btn == 'ok'){
			txtReason.setRawValue(text)
 
		    }
		});
                } 

                save_click();       

            }
        }]);

new Ext.KeyMap( Ext.getBody(), [{
            key: "e",
            ctrl:true,
            fn: function( e, ele ){
                ele.preventDefault();
             edit_click();

            }
        }]);


new Ext.KeyMap( Ext.getBody(), [{
            key: "x",
            ctrl:true,
            fn: function( e, ele ){
                ele.preventDefault();
                  BankReceiptEntryWindow.hide();

            }
        }]);

new Ext.KeyMap( Ext.getBody(), [{
            key: "a",
            ctrl:true,
            fn: function( e, ele ){
                ele.preventDefault();
                  add_btn_click();
            }
        }]);


    var lblReason = new Ext.form.Label({
        fieldLabel: 'Reason for Modification',
        id: 'lblReason',
        width: 300,
       labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });


    var txtReason = new Ext.form.TextField({
        fieldLabel: '',
        id: 'txtReason',
        width: 400,
        name: 'txtReason',
        enableKeyEvents: true,
	autoCreate:{tag:'input',type:'text',size:'20',autocomplete:'off',maxlength:'49'},

        listeners: {
        }
    });



function RecordSave()
{

                        Ext.getCmp('save').setDisabled(true);  

		        var accData = flxDetail.getStore().getRange();
		        var accupdData = new Array();
		        Ext.each(accData, function (record) {
		            accupdData.push(record.data);
		        });

		        var accadjData = flxAdjustDetails.getStore().getRange();
		        var accadjupdData = new Array();
		        Ext.each(accadjData, function (record) {
		            accadjupdData.push(record.data);
		        });


		        var CreditNoteData = flxAccounts.getStore().getRange();
		        var CreditNoteupdData = new Array();
		        Ext.each(CreditNoteData, function (record) {
		            CreditNoteupdData.push(record.data);
		        });

		        Ext.Ajax.request({
		            url: 'FrmTrnBankReceiptSave.php',
		            params: {
		                griddet: Ext.util.JSON.encode(accupdData),
		                gridadjdet: Ext.util.JSON.encode(accadjupdData),
		                gridcreditnote: Ext.util.JSON.encode(CreditNoteupdData),

		                cnt: accData.length,
		                adjcnt: accadjData.length,
                	        creditnotecnt: CreditNoteData.length,

                                finsuffix :invfin,
		                finid: GinFinid,
		                finyear: gstfinyear,
		                compcode: GinCompcode,
		                accrefseq: seqno,
		                vouno: txtVouNo.getRawValue(),
		                voudate: Ext.util.Format.date(dtpVouDate.getValue(), "Y-m-d"),
		                bankname: txtBankName.getRawValue(),
		                refno: txtRefNo.getRawValue(),
		                refdate: Ext.util.Format.date(dtpRefDate.getValue(), "Y-m-d"),
		                narration: txtNarration.getRawValue(),
		                paytype: gstPaytype,
		                paymode: cmbPaymode.getRawValue(),
		                payno: txtNo.getRawValue(),
		                paydate: Ext.util.Format.date(dtpDate.getValue(), "Y-m-d"),
		                headacct: cmbHeadAccount.getValue(),
		                rcptamt  : Number(txtTotCredit.getRawValue()) , //- Number(txtTotDebit.getRawValue()),
		                totadjamt: Number(txtTotNetAmt.getRawValue()),
                                usercode : GinUserid, 
                                reason   : txtReason.getRawValue(),
		                flagtype: gstFlag,

                                usercode : GinUserid,
                                qty      : txtQty.getRawValue(),


                                generateCN : 'YES',
		                CNRemarks: txtCNRemarks.getRawValue(),  
                                cgstledcode : cgstledcode,
                                sgstledcode : sgstledcode,
                                igstledcode : igstledcode,

                                salledcode  : salledcode,

                                ledgercode  : ledgercode,
                                partycode   : partycode,
                                CreditValue : txtTotCDAmt.getValue(),
                                roff        : rounding, 
                                itemname    : quality,

                                crnoteseqno : crnoteseqno,
                                cnvouno     : txtCNNo.getValue(),  
                                billnolist  : billnolist,  

		              },
		            callback: function (options, success, response)
		            {
		                var obj = Ext.decode(response.responseText);
		                if (obj['success'] === "true") {


                                    BankReceiptEntryFormPanel.remove(flxAccounts, false);
                                    tabAccounts.setActiveTab(0);
				    flxAccounts.getStore().removeAll();
                                    flxAccounts.store.clearData();
				    flxDetail.getStore().removeAll();
				    flxAccounts.getStore().removeAll();
				    RefreshData();
				    Ext.getCmp('txtAccountName').focus(false, 200);


			Ext.MessageBox.show({
			    title: "",
			    msg: "Bank Receipt Entry Saved -" + obj['vouno'],
			    icon: Ext.MessageBox.WARNING,
			    buttons: Ext.MessageBox.OK,
			    fn: function(buttonId) {
				if (buttonId === "ok") {
                                    BankReceiptEntryFormPanel.remove(flxAccounts, false);
                                    tabAccounts.setActiveTab(0);
				    flxAccounts.getStore().removeAll();
                                    flxAccounts.store.clearData();
				    flxDetail.getStore().removeAll();
				    flxAccounts.getStore().removeAll();
				    RefreshData();
				    Ext.getCmp('txtAccountName').focus(false, 200);
				}
			    }
			});

		               }
		                 else {
                               	Ext.MessageBox.alert("Bank Receipt Not Saved! Pls Check!- " + obj['vouno']);  
		                }
		            }
		        });//msg2
}

function save_click() 
{


        var saverecord = 'Y';

	Caladj();
	var rcnt = flxDetail.getStore().getCount();
	fromdate = "04/01/" + gstfinyear.substring(0, 4);
	todate = "03/31/" + gstfinyear.substring(5, 9);
        if (gstFlag == "Edit" && (txtReason.getRawValue() == ''  || txtReason.getRawValue().length <5  )  )
        {
            Ext.MessageBox.alert("Alert", "Reason for Edit is mandatory. Provide Reason..");
		Ext.Msg.prompt('Reason for Modification', '', function(btn, text){
		    if (btn == 'ok'){
			txtReason.setRawValue(text)
                        save_click();
		    }
		});

        }
	else if (Ext.util.Format.date(dtpVouDate.getValue(), "Y-m-d") < Ext.util.Format.date(fromdate, "Y-m-d")) {
	    Ext.MessageBox.alert("Alert", "Voucher Date not in current finyear");
	}
        else if (rcnt == 0) {
            Ext.MessageBox.alert("Alert", "Check Receipt Amount and Press Enter Key in the Receipt Amount");
        } 
        else if (Ext.util.Format.date(dtpVouDate.getValue(), "Y-m-d") > Ext.util.Format.date(todate, "Y-m-d")) {
	    Ext.MessageBox.alert("Alert", "Voucher Date not in current finyear");
	} else if (rcnt <= 0) {
	    Ext.MessageBox.alert("Receipt", "Transactions Details Not Available ..");
	} else if (cmbHeadAccount.getValue() == 0) {
	    Ext.MessageBox.alert("Receipt", "Select the Head of Account");
	} else if (cmbHeadAccount.getRawValue() == '') {
	    Ext.MessageBox.alert("Receipt", "Select the Head of Account");
	} else if (txtTotNetAmt.getRawValue() <= 0 && gstPaytype == "BB") {
	    Ext.MessageBox.alert("Receipt", "You have selected Bill to Bill mode & no bills are adjusted" + totadjamtvalue);
	} else if (txtTotNetAmt.getRawValue() > 0 && gstPaytype == "AD") {
	    Ext.MessageBox.alert("Receipt", "You have to select Bill to Bill mode in order to adjust bills");
	} else if (Number(txtTotNetAmt.getRawValue()) > Number(txtTotCredit.getRawValue()) ) {
	    Ext.MessageBox.alert("Receipt", "Adjusted Amout is heigh then received amount");
	} 
        else if( Number(txtTotCDAmt.getValue()) > 0 && Number(txtDebitTotal.getValue())!=Number(txtCreditTotal.getValue())){
     Ext.MessageBox.alert("Receipt","In Credit Note,  Debit and Credit Totals are not Equal. click CREDIT NOTE tab and continue");


/*
            var diff = 0;
            diff =  Number(txtDebitTotal.getValue())-Number(txtDebitTotal.geValue()); 
            var sel1 = flxAccounts.getSelectionModel().getSelections();           		
            sel1[1].set('debit',sel1[1].get('debit')-diff);
alert(diff);
*/

        }

        else if( Number(txtTotCDAmt.getValue()) > 0 && (Number(txtDebitTotal.getValue()) == 0 || Number(txtCreditTotal.getValue())== 0 ) ){
            Ext.MessageBox.alert("Receipt","Credit Note Debit and Credit Total are not Equal. click CREDIT NOTE tab and continue")
        }
        else if( Number(txtTotNetAmt.getValue()) >  Number(txtRecAmt.getValue())  ){
            Ext.MessageBox.alert("Receipt","Adjustment amount is heigher than receipt amount. Can't save the record")
        }

        else if( Number(txttotCDValue.getValue()) > 0 && txtCNRemarks.getRawValue() == "" ){
            Ext.MessageBox.alert("Receipt","Credit Note Remark is Empty. Can't save the record")
        }


        else {
	    Caladj();
	    Ext.Msg.show({
		title: 'Receipt Voucher',
		icon: Ext.Msg.QUESTION,
		buttons: Ext.MessageBox.YESNO,
		msg: 'Are You Sure to Add This Record?',
		fn: function (btn) {
		    if (btn == 'yes') {

                    if (Number(txtTotCDAmt.getValue()) > 0)
                    { 

                          saverecord = 'N';
                        Ext.Msg.show({
                            title: 'Confirmation Again',
                            icon: Ext.Msg.QUESTION,
                            buttons: Ext.MessageBox.YESNO,
                            msg: 'This Receipt having CREDIT NOTE . Kindly CONFIRM AGAIN to SAVE the Record..',
                            fn: function(btn)
                            {
                                if (btn === 'yes')
                                {   
                                   saverecord = 'Y';
                                   RecordSave();
                                }   
                                else
                                   saverecord = 'N';



                            }
                        });
                     }
                     else
                     {
                          saverecord = 'Y';
                     }  

                  
                     if (saverecord == 'Y' )
                     {
                        RecordSave();


                    } // save record
		    }
		}
  
	    });//msg1
	}

}


function edit_click() 
{
    gstFlag = "Edit";
    cmbVouNo.show();
	Voucherdatastore.load({
	    url: '/SHVPM/Accounts/clsAccounts.php',
	    params:
	    {
		task: "cmbvoucher",
		finid    : GinFinid,
		compcode : GinCompcode,
		voutype  :'BKR',
	    }
	});

}

function add_btn_click()
{
//alert(txtAccountName.getRawValue());
//alert(ledgercode);
//alert(ledtype);
                flxDetail.getStore().removeAll();
                flxAdjustDetails.getStore().removeAll();
                var gstInsert = "true";
                if (ledgercode == 0) {
                    gstInsert = "false";
                    Ext.MessageBox.alert("Receipt", "Select Ledger");
                }
                if (txtAccountName.getRawValue() == '') {
                    gstInsert = "false";
                    Ext.MessageBox.alert("Receipt", "Select Ledger");
                }


                if (txtAccountName.getRawValue() == cmbHeadAccount.getRawValue()) {
                    gstInsert = "false";
                    Ext.MessageBox.alert("Receipt", "Select Different Ledger");
                }



                flxDetail.getSelectionModel().selectAll();
                var selrows = flxDetail.getSelectionModel().getCount();
                var sel = flxDetail.getSelectionModel().getSelections();
                var cnt = 0;
                for (var i = 0; i < selrows; i++) {
                    if (sel[i].data.ledseq == ledgercode) {
                        cnt = cnt + 1;
                    }
                }
                if (gstInsert == "true")
                {
                   if (gridedit === "false")
                   { 

		        if (cnt > 0){
		            gstInsert = "false";
		            Ext.MessageBox.alert("Receipt","This Ledger Already Entered");
		        }
                   }
                   if (gridedit === "true")
                   {


			var idx = flxDetail.getStore().indexOf(editrow);
               		sel[idx].set('ledname' , txtAccountName.getRawValue());
	 		sel[idx].set('cramt'   , Number(txtReceiptAmt.getRawValue()));
			sel[idx].set('ledseq'  , ledgercode);
			sel[idx].set('ledtype' , ledtype);
			flxDetail.getSelectionModel().clearSelections();
			gridedit = "false";
                        CalcTotalDebitCredit();
//                        txtReceiptAmt.setRawValue('');
                        Ext.getCmp('btnAdd').setDisabled(true);  
	            }//if(gridedit === "true")
                    else
                    if  (cnt ==0){
                       if (gstInsert == "true") {

                           var totamt;
                           var RowCnt = flxDetail.getStore().getCount() + 1;
                           flxDetail.getStore().insert(
                             flxDetail.getStore().getCount(),
                             new dgrecord({
                                slno: RowCnt,
                                ledname  : txtAccountName.getRawValue(),
                 
                                cramt    : Number(txtReceiptAmt.getRawValue()),
                                dbamt    : 0,
                                ledseq   : ledgercode,

                                ledtype  : ledtype,
                             })
                            );

//                           txtReceiptAmt.setRawValue('');
                           CalcTotalDebitCredit();


                           BillAdjustingDetail();
                           Ext.getCmp('btnAdd').setDisabled(true);  
                      }
                   }
//                   txtAccountName.setRawValue('');    
//                   ledgercode = 0;   
               }
}

    var Voucherdatastore = new Ext.data.Store({
        id: 'Voucherdatastore',
        proxy: new Ext.data.HttpProxy({
                  url: '/SHVPM/Accounts/clsAccounts.php',      // File to connect to
                  method: 'POST'
              }),
              baseParams:{task: "cmbvoucher"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
                    // we tell the datastore where to get his data from
          root: 'results',
          totalProperty: 'total',
          id: 'id'
        },[
          {name: 'vou_seqno', type: 'int', mapping: 'accref_seqno'},
          {name: 'vou_no', type: 'string', mapping: 'accref_vouno'}
        ]),
//        sortInfo:{field: 'vou_seqno', direction: "ASC"}
    });
    
    var VouNodatastore = new Ext.data.Store({
        id: 'VouNodatastore',
        proxy: new Ext.data.HttpProxy({
                  url: '/SHVPM/Accounts/clsAccounts.php',      // File to connect to
                  method: 'POST'
              }),
              baseParams:{task: "LoadLastVouNo"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
                    // we tell the datastore where to get his data from
          root: 'results',
          totalProperty: 'total',
          id: 'id'
        },['con_value'])
    });

    
    var VouNodatastore2 = new Ext.data.Store({
        id: 'VouNodatastore2',
        proxy: new Ext.data.HttpProxy({
                  url: '/SHVPM/Accounts/clsAccounts.php',      // File to connect to
                  method: 'POST'
              }),
              baseParams:{task: "LoadLastVouNo"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
                    // we tell the datastore where to get his data from
          root: 'results',
          totalProperty: 'total',
          id: 'id'
        },['con_value'])
    });


    
    var VouNodatastore3 = new Ext.data.Store({
        id: 'VouNodatastore3',
        proxy: new Ext.data.HttpProxy({
                  url: 'clsBankReceipt.php',      // File to connect to
                  method: 'POST'
              }),
              baseParams:{task: "ControlCreditNo"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
                    // we tell the datastore where to get his data from
          root: 'results',
          totalProperty: 'total',
          id: 'id'
        },['accref_vouno'])
    });


    var LoadGSTDetailsdatastore = new Ext.data.Store({
        id: 'LoadGSTDetailsdatastore',
        proxy: new Ext.data.HttpProxy({
                  url: 'clsBankReceipt.php',      // File to connect to
                  method: 'POST'
              }),
              baseParams:{task: "LoadInvGSTDetails"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
                    // we tell the datastore where to get his data from
          root: 'results',
          totalProperty: 'total',
          id: 'id'
        },['acctran_accref_seqno', 'cust_acc_group','acctran_led_code', 'cust_name', 'invh_acc_refno', 'hsncode'])
    });



    var LoadVouNoDetailsdatastore = new Ext.data.Store({
        id: 'LoadVouNoDetailsdatastore',
        proxy: new Ext.data.HttpProxy({
                  url: 'clsBankReceipt.php',      // File to connect to
                  method: 'POST'
              }),
              baseParams:{task: "LoadBRVoucherDetails"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
                    // we tell the datastore where to get his data from
          root: 'results',
          totalProperty: 'total',
          id: 'id'
        },['accref_seqno', 'accref_vouno', 'accref_voudate', 'accref_vou_type', 'accref_bank_name', 'accref_paymode', 'accref_payref_no',
'accref_payref_date', 'accref_narration', 'accref_chq_status', 'accref_reverse_status', 'acctran_accref_seqno', 
'acctran_serialno', 'acctran_led_code', 'acctran_dbamt', 'acctran_cramt', 'acctran_totamt', 'acctran_paytype',
'cust_name', 'cust_add1','cust_type',  ,'cust_grp_code','accref_link_seqno'])
    });


    var LoadCNOTEVouNoDetailsdatastore = new Ext.data.Store({
        id: 'LoadCNOTEVouNoDetailsdatastore',
        proxy: new Ext.data.HttpProxy({
                  url: 'clsBankReceipt.php',      // File to connect to
                  method: 'POST'
              }),
              baseParams:{task: "LoadCreditNoteVoucherDetails"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
                    // we tell the datastore where to get his data from
          root: 'results',
          totalProperty: 'total',
          id: 'id'
        },['accref_seqno', 'accref_vouno', 'accref_voudate', 'accref_vou_type', 'accref_bank_name', 'accref_paymode', 'accref_payref_no',
'accref_payref_date', 'accref_narration', 'accref_chq_status', 'accref_reverse_status', 'acctran_accref_seqno', 
'acctran_serialno', 'acctran_led_code', 'acctran_dbamt', 'acctran_cramt', 'acctran_totamt', 'acctran_paytype',
'cust_name', 'led_addr1', 'led_addr2','led_type', 'led_custcode' ,'cust_acc_group','accref_link_seqno'])
    });



    var LoadCNOTEAmountDetailsdatastore = new Ext.data.Store({
        id: 'LoadCNOTEAmountDetailsdatastore',
        proxy: new Ext.data.HttpProxy({
                  url: 'clsBankReceipt.php',      // File to connect to
                  method: 'POST'
              }),
              baseParams:{task: "LoadCreditNoteAmountDetails"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
                    // we tell the datastore where to get his data from
          root: 'results',
          totalProperty: 'total',
          id: 'id'
        },['dbcrt_seqno', 'dbcrt_inv_no', 'dbcrt_inv_date', 'dbcrt_grossvalue', 'dbcrt_value', 'dbcrt_igstvalue', 'dbcrt_cgstvalue', 'dbcrt_sgstvalue', 'dbcrt_igstper', 'dbcrt_cgstper', 'dbcrt_sgstper', 'dbcrt_igstledcode', 'dbcrt_cgstledcode', 'dbcrt_sgstledcode', 'dbcrt_tcsvalue', 'dbcrt_tcsper', 'dbcrt_tcsledcode', 'dbcrt_otheramt', 'dbcrt_otherledcode', 'dbcrt_rounding', 'dbcrt_frtamt', 'dbcrt_frtledcode', 'dbcrt_taxable'])
    });


    var LoadAdjustmentDetailsdatastore = new Ext.data.Store({
        id: 'LoadAdjustmentDetailsdatastore',
        proxy: new Ext.data.HttpProxy({
                  url: 'clsBankReceipt.php',      // File to connect to
                  method: 'POST'
              }),
              baseParams:{task: "LoadBillAdjustmentDetails"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
                    // we tell the datastore where to get his data from
          root: 'results',
          totalProperty: 'total',
          id: 'id'
        },['ref_slno', 'ref_docseqno', 'ref_docno', 'ref_docdate', 'ref_adjseqno', 'ref_adjvouno', 'ref_invno', 'ref_invdate', 'ref_adjamount', 'ref_paymt_terms', 'ref_adj_days', 'ref_adj_by', 'ref_adjusted_on',
'acctrail_accref_seqno' , 'acctrail_inv_value',  'acctrail_led_code','acctrail_crdays','ref_adjvoutype',
'acctrail_gracedays','invh_crd_days', 'invh_grace_days',  'ordh_payterm_30days_7days_receipt', 'ordh_payterm_45days_7days_receipt', 'ordh_payterm_45days_30days_receipt', 'ordh_payterm_60days_7days_receipt', 'ordh_payterm_60days_30days_receipt', 'ordh_payterm_60days_45days_receipt',  'ordh_payterm_90days_7days_receipt', 'ordh_payterm_90days_30days_receipt', 'ordh_payterm_90days_45days_receipt',  'ordh_payterm_90days_60days_receipt', 'ordh_payterm_90days_75days_receipt','invwt', 'invh_taxableamt','rate_cashdisc_per','invh_cgst_per','invh_sgst_per', 'invh_igst_per','invh_frt_amt', 'dbcrt_inv_no', 'dbcrt_taxable', 'dbcrt_igstvalue', 'dbcrt_cgstvalue', 'dbcrt_sgstvalue', 'dbcrt_value', 'dbcrt_igstper', 'dbcrt_cgstper', 'dbcrt_sgstper', 'dbcrt_igstledcode', 'dbcrt_cgstledcode', 'dbcrt_sgstledcode','ordh_ratediff'
])
    });




    var LoadInvoiceCashDiscountDetailsdatastore = new Ext.data.Store({
        id: 'LoadInvoiceCashDiscountDetailsdatastore',
        proxy: new Ext.data.HttpProxy({
                  url: 'clsBankReceipt.php',      // File to connect to
                  method: 'POST'
              }),
              baseParams:{task: "loadInvoiceCashDiscountDetails"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
                    // we tell the datastore where to get his data from
          root: 'results',
          totalProperty: 'total',
          id: 'id'
        },[
 'dbcrt_inv_no', 'dbcrt_taxable', 'dbcrt_igstvalue', 'dbcrt_cgstvalue', 'dbcrt_sgstvalue', 'dbcrt_value', 'dbcrt_igstper', 'dbcrt_cgstper', 'dbcrt_sgstper', 'dbcrt_igstledcode', 'dbcrt_cgstledcode', 'dbcrt_sgstledcode'
])
    });

    var findLedgerdatastore = new Ext.data.Store({
        id: 'findLedgerdatastore',
        proxy: new Ext.data.HttpProxy({
            url: '/SHVPM/Accounts/clsAccounts.php', // File to connect to
            method: 'POST'
        }),
        baseParams: {task: "loadledger_type_name"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
            // we tell the datastore where to get his data from
            root: 'results',
            totalProperty: 'total',
            id: 'id'
        }, [
            {name: 'cust_code', type: 'int', mapping: 'cust_code'},
            {name: 'cust_name', type: 'string', mapping: 'cust_name'},
            {name: 'led_type', type: 'string', mapping: 'led_type'},
        ]),
        sortInfo: {field: 'cust_name', direction: "ASC"}
    });

    var LoadAddnl_CDDays_Detdatastore = new Ext.data.Store({
        id: 'LoadAddnl_CDDays_Detdatastore',
        proxy: new Ext.data.HttpProxy({
            url: 'clsBankReceipt.php', // File to connect to
            method: 'POST'
        }),
        baseParams: {task: "load_Addnl_CD_Days"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
            // we tell the datastore where to get his data from
            root: 'results',
            totalProperty: 'total',
            id: 'id'
        }, ['cust_addnl_cd_days'
])
    });


    var ReceiptAdjBillDetdatastore = new Ext.data.Store({
        id: 'ReceiptAdjBillDetdatastore',
        proxy: new Ext.data.HttpProxy({
            url: '/SHVPM/Accounts/clsAccounts.php', // File to connect to
            method: 'POST'
        }),
        baseParams: {task: "getrcptadjbilldet"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
            // we tell the datastore where to get his data from
            root: 'results',
            totalProperty: 'total',
            id: 'id'
        }, ['accref_seqno', 'accref_vou_type', 'accref_vouno', 'accref_voudate', 'accref_comp_code',
            'accref_finid', 'acctrail_inv_no', 'acctrail_inv_date', 'acctrail_inv_date2','acctrail_inv_value',
            'acctrail_adj_value', 'acctran_cramt', 'acctran_dbamt', 'dbcr_invvalue', 'acctrail_crdays', 'acctrail_gracedays','invh_crd_days', 'invh_grace_days','ordh_payterm_30days_7days_receipt', 'ordh_payterm_45days_7days_receipt', 'ordh_payterm_45days_30days_receipt','ordh_payterm_60days_7days_receipt',
 'ordh_payterm_60days_30days_receipt' ,'ordh_payterm_45days_7days_receipt', 'ordh_payterm_45days_30days_receipt',
'ordh_payterm_60days_7days_receipt',  'ordh_payterm_60days_30days_receipt', 'ordh_payterm_60days_45days_receipt',
'ordh_payterm_90days_7days_receipt','ordh_payterm_90days_30days_receipt','ordh_payterm_90days_45days_receipt','ordh_payterm_90days_60days_receipt',
'ordh_payterm_90days_75days_receipt','invwt','invh_taxableamt','rate_cashdisc_per','invh_cgst_per','invh_sgst_per','invh_igst_per','invh_frt_amt',
'ordh_ratediff'

])
    });

    var OpeningBillDetdatastore = new Ext.data.Store({
        id: 'OpeningBillDetdatastore',
        proxy: new Ext.data.HttpProxy({
            url: '/SHVPM/Accounts/clsAccounts.php', // File to connect to
            method: 'POST'
        }),
        baseParams: {task: "getobadjbilldet"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
            // we tell the datastore where to get his data from
            root: 'results',
            totalProperty: 'total',
            id: 'id'
        }, ['ob_seqno', 'ob_vou_no', 'ob_vou_date', 'ob_comp_code', 'ob_fin_id', 'ob_led_code', 'ob_ref_no',
            'ob_ref_date', 'ob_totamt', 'ob_adjamt', 'ob_cramt', 'ob_dbamt', 'dbcr_invvalue',
'invno', 'invdate', 'invamt', 'adjamt', 'pendingamt', 'acctrail_led_code', 'accref_comp_code', 'accref_finid', 'accref_seqno', 'accref_vouno', 'accref_vou_type'
])
    });

    var BillDetailDataStore = new Ext.data.Store({
        proxy: new Ext.data.HttpProxy({
            url: '/SHVPM/Accounts/clsAccounts.php'
        }),
        reader: new Ext.data.JsonReader({
            root: 'rows',
            totalProperty: 'results',
            id: 'BillDetailDataStore'
        }, ['invno', 'invdate', 'invamt', 'dbcramt', 'totamt', 'pendingamt', 'adjamt', 'voutype', 'balamt',
            'accrefseqno', 'accrefvouno',
  'acctrail_led_code', 'accref_comp_code', 'accref_finid', 'accref_seqno', 'accref_vouno', 'accref_vou_type',
'invh_crd_days', 'invh_grace_days','ordh_payterm_30days_7days_receipt ', 'ordh_payterm_60days_30days_receipt' , 'ordh_payterm_60days_45days_receipt'

])
    });

    var AccountDetDataStore = new Ext.data.Store({
        proxy: new Ext.data.HttpProxy({
            url: '/SHVPM/Accounts/clsAccounts.php'
        }),
        reader: new Ext.data.JsonReader({
            root: 'rows',
            totalProperty: 'results',
            id: 'AccountDetDataStore'
        }, ['slno', 'ledname', 'currency', 'amount', 'exgrate', 'type', 'dbamt', 'cramt', 'ledseq', 'curseq', 'totamt'])
    });

    var Currencydatastore = new Ext.data.Store({
        id: 'Currencydatastore',
        proxy: new Ext.data.HttpProxy({
            url: '/SHVPM/Accounts/clsAccounts.php', // File to connect to
            method: 'POST'
        }),
        baseParams: {task: "cmbcurrency"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
            // we tell the datastore where to get his data from
            root: 'results',
            totalProperty: 'total',
            id: 'id'
        }, [
            {name: 'cur_code', type: 'int', mapping: 'currency_code'},
            {name: 'cur_name', type: 'string', mapping: 'currency_symbol'}
        ]),
        sortInfo: {field: 'cur_code', direction: "ASC"}
    });

    var Ledgerdatastore = new Ext.data.Store({
        id: 'Ledgerdatastore',
        proxy: new Ext.data.HttpProxy({
            url: '/SHVPM/Accounts/clsAccounts.php', // File to connect to
            method: 'POST'
        }),
        baseParams: {task: "LoadAllLedgerList"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
            // we tell the datastore where to get his data from
            root: 'results',
            totalProperty: 'total',
            id: 'id'
        }, [
            {name: 'cust_code', type: 'int', mapping: 'cust_code'},
            {name: 'cust_name', type: 'string', mapping: 'cust_name'}
        ]),
        sortInfo: {field: 'cust_name', direction: "ASC"}
    });

    var HeadAccountdatastore = new Ext.data.Store({
        id: 'HeadAccountdatastore',
        proxy: new Ext.data.HttpProxy({
            url: '/SHVPM/Accounts/clsAccounts.php', // File to connect to
            method: 'POST'
        }),
        baseParams: {task: "cmbbankacct"}, // this parameter asks for listing
        reader: new Ext.data.JsonReader({
            // we tell the datastore where to get his data from
            root: 'results',
            totalProperty: 'total',
            id: 'id'
        }, [
            {name: 'cust_code', type: 'int', mapping: 'cust_code'},
            {name: 'cust_name', type: 'string', mapping: 'cust_name'}
        ]),
        sortInfo: {field: 'cust_name', direction: "ASC"}
    });

    function remarkfun() {
        Caladj();
//        txtRefBills.setRawValue('');
        txtNarration.setRawValue("");
        flxAdjustDetails.getSelectionModel().selectAll();
        var selrows = flxAdjustDetails.getSelectionModel().getCount();
        var sel = flxAdjustDetails.getSelectionModel().getSelections();
        gstbillnos = "";
        narra = '';
        for (var i = 0; i < selrows; i++) {
            if (Number(sel[i].data.adjamt) > 0) {
                gstbillnos = gstbillnos + sel[i].data.invno + ",";
            }
        }
   //     txtRefBills.setRawValue(gstbillnos);
        txtNarration.setRawValue("RECEIVED VIDE " + txtBankName.getRawValue() + " - " + cmbPaymode.getRawValue() + " No. " + txtRefNo.getRawValue() +   "  Dated : " + dtpRefDate.getRawValue() + "      " + "RefNo:" + gstbillnos  );
    }

    function Caladj() {
        flxAdjustDetails.getSelectionModel().selectAll();
        var selrows = flxAdjustDetails.getSelectionModel().getCount();
        var sel = flxAdjustDetails.getSelectionModel().getSelections();
        totadjamtvalue = 0;
        for (var i = 0; i < selrows; i++) {
            if (Number(sel[i].data.adjamt) > 0) {
                totadjamtvalue = Number(totadjamtvalue) + Number(sel[i].data.adjamt);
            }
        }
        txtTotNetAmt.setValue(totadjamtvalue);
    }



    function CalcTotalDebitCredit() {



        flxDetail.getSelectionModel().selectAll();
        var selrows = flxDetail.getSelectionModel().getCount();
        var sel = flxDetail.getSelectionModel().getSelections();

        var gincdamt = 0;  
        var gincdval = 0;      
        var gindbtotal = 0;
        var gincrtotal = 0;

        var gincgstamt = 0;
        var ginsgstamt = 0;
        var ginigstamt = 0;   

        for (var i = 0; i < selrows; i++) {

            if (Number(sel[i].data.adjamt) == 0 && Number(sel[i].data.cdamount) > 0 )
            {
                    var rec = flxAdjustDetails.getStore().getAt(i);
                    rec.set('adjamt', 0);
                    rec.set('cdvalue', 0);
                    rec.set('cgstamount', 0);
                    rec.set('sgstamount', 0);
                    rec.set('igstamount', 0);
                    rec.set('cdamount', 0);
            }  

            gindbtotal = gindbtotal + Number(sel[i].data.dbamt);
            gincrtotal = gincrtotal + Number(sel[i].data.cramt);
            gincdamt   = gincdamt   + Number(sel[i].data.cdamount);
            gincdval   = gincdval   + Number(sel[i].data.cdvalue);

            gincgstamt = gincgstamt   + Number(sel[i].data.cgstamount);
            ginsgstamt = ginsgstamt   + Number(sel[i].data.sgstamount);
            ginigstamt = ginigstamt   + Number(sel[i].data.igstamount);
        }

        txtTotDebit.setValue(gindbtotal);
        txtTotCredit.setValue(gincrtotal);
        txtTotCDAmt.setValue(gincdamt);
        txtTotCDValue.setValue(gincdval);

        txtTotCGSTAmount.setValue(gincgstamt);
        txtTotSGSTAmount.setValue(ginsgstamt);
        txtTotIGSTAmount.setValue(ginigstamt);


        txtRecAmt.setValue(Number(txtTotCredit.getRawValue()) - Number(txtTotDebit.getRawValue()));



        if (gstFlag == "Edit" && crnoteseqno > 0 && Number(gincdamt) == 0 )
        {
             alert("You can't remove all adjustments. Because Alreday credit note generated..")
             Ext.getCmp('save').setDisabled(true);  
alert("1");             
        }               
        else
        {
             Ext.getCmp('save').setDisabled(false);               
        }               



        flxaccupdation(); 
    }

    function BillAdjustingDetail() {

        var pendamt = 0;
        var balamt = 0;
        txtAddnlCDDays.setValue(0);

            LoadAddnl_CDDays_Detdatastore.removeAll();
            LoadAddnl_CDDays_Detdatastore.load({
                url: 'clsBankReceipt.php',
                params:
                        {
                            task: "load_Addnl_CD_Days",
                            custcode : partycode,
                        },
                callback: function () {
         	var cnt = LoadAddnl_CDDays_Detdatastore.getCount();
                if (cnt > 0)
                {
                     txtAddnlCDDays.setValue(LoadAddnl_CDDays_Detdatastore.getAt(0).get('cust_addnl_cd_days'));   
                } 
                }
            });  


        if (flxDetail.getStore().getCount() == 1 && gstPaytype === "BB") {
            var ginledcode = flxDetail.getStore().getAt(0).get('ledseq');

            var dt_coll = dtpRefDate.getValue();

            ReceiptAdjBillDetdatastore.removeAll();
            ReceiptAdjBillDetdatastore.load({
                url: '/SHVPM/Accounts/clsAccounts.php',
                params:
                        {
                            task: "getrcptadjbilldet",
                            finid: GinFinid,
                            ledcode: ledgercode , //ginledcode,
                            compcode: GinCompcode
                        },
                callback: function () {
                    var RowCnt = ReceiptAdjBillDetdatastore.getCount();

                    for (var i = 0; i < RowCnt; i++) {
                        pendamt = Number(ReceiptAdjBillDetdatastore.getAt(i).get('acctrail_inv_value')) -
                                  Number(ReceiptAdjBillDetdatastore.getAt(i).get('acctrail_adj_value'));
                        pendamt = pendamt.toFixed(2); 
                        pendamt =  Ext.util.Format.number(pendamt,'0.00');

                        var tax = ReceiptAdjBillDetdatastore.getAt(i).get('invh_taxableamt')-ReceiptAdjBillDetdatastore.getAt(i).get('invh_frt_amt');
//alert(tax);
//alert(ReceiptAdjBillDetdatastore.getAt(i).get('acctrail_inv_no'));

//alert(ReceiptAdjBillDetdatastore.getAt(i).get('ordh_payterm_90days_7days_receipt'));


                        flxAdjustDetails.getStore().insert(
                                flxAdjustDetails.getStore().getCount(),
                                new dgadjrecord({
                                    invno: ReceiptAdjBillDetdatastore.getAt(i).get('acctrail_inv_no'),
                                    invdate: ReceiptAdjBillDetdatastore.getAt(i).get('acctrail_inv_date'),
                                    invdate2: ReceiptAdjBillDetdatastore.getAt(i).get('acctrail_inv_date2'),
                                    payterms: ReceiptAdjBillDetdatastore.getAt(i).get('acctrail_crdays'),
                                    grdays: ReceiptAdjBillDetdatastore.getAt(i).get('acctrail_gracedays'),

                                    invamt: ReceiptAdjBillDetdatastore.getAt(i).get('acctrail_inv_value'),
                                    dbcramt: ReceiptAdjBillDetdatastore.getAt(i).get('dbcr_invvalue'),
                                    totamt: 0,
                                    pendingamt:Ext.util.Format.number(pendamt,'0.00'),
                                    pendingamt2:Ext.util.Format.number(pendamt,'0.00'),

                                    adjamt: 0,
                                    voutype: ReceiptAdjBillDetdatastore.getAt(i).get('accref_vou_type'),
 //                                   balamt: Number(ReceiptAdjBillDetdatastore.getAt(i).get('acctrail_inv_value')) -
//                                            Number(ReceiptAdjBillDetdatastore.getAt(i).get('acctrail_adj_value')),
                                    balamt:Ext.util.Format.number(pendamt,'0.00'),
                                    accrefseqno: ReceiptAdjBillDetdatastore.getAt(i).get('accref_seqno'),
                                    accrefvouno: ReceiptAdjBillDetdatastore.getAt(i).get('accref_vouno'),

                                    crddays: ReceiptAdjBillDetdatastore.getAt(i).get('invh_crd_days'),

                                    PMT30dayscdamt: ReceiptAdjBillDetdatastore.getAt(i).get('ordh_payterm_30days_7days_receipt'),

                                    PMT45dayscdamt1: ReceiptAdjBillDetdatastore.getAt(i).get('ordh_payterm_45days_7days_receipt'),
                                    PMT45dayscdamt2: ReceiptAdjBillDetdatastore.getAt(i).get('ordh_payterm_45days_30days_receipt'),


                                    PMT60dayscdamt1: ReceiptAdjBillDetdatastore.getAt(i).get('ordh_payterm_60days_7days_receipt'),
                                    PMT60dayscdamt2: ReceiptAdjBillDetdatastore.getAt(i).get('ordh_payterm_60days_30days_receipt'),
                                    PMT60dayscdamt3: ReceiptAdjBillDetdatastore.getAt(i).get('ordh_payterm_60days_45days_receipt'),


                                    PMT90dayscdamt1: ReceiptAdjBillDetdatastore.getAt(i).get('ordh_payterm_90days_7days_receipt'),
                                    PMT90dayscdamt2: ReceiptAdjBillDetdatastore.getAt(i).get('ordh_payterm_90days_30days_receipt'),
                                    PMT90dayscdamt3: ReceiptAdjBillDetdatastore.getAt(i).get('ordh_payterm_90days_45days_receipt'),
                                    PMT90dayscdamt4: ReceiptAdjBillDetdatastore.getAt(i).get('ordh_payterm_90days_60days_receipt'),
                                    PMT90dayscdamt5: ReceiptAdjBillDetdatastore.getAt(i).get('ordh_payterm_90days_75days_receipt'),


                                    ratediff: ReceiptAdjBillDetdatastore.getAt(i).get('ordh_ratediff'),
                                    invwt: ReceiptAdjBillDetdatastore.getAt(i).get('invwt'),
                                    taxable: tax,
                                    cdper: ReceiptAdjBillDetdatastore.getAt(i).get('rate_cashdisc_per'),

//                                    cdvalue : 0,
                                    cgstper  : ReceiptAdjBillDetdatastore.getAt(i).get('invh_cgst_per'),
                                    cgstamount: 0,
                                    sgstper  : ReceiptAdjBillDetdatastore.getAt(i).get('invh_sgst_per'),
                                    sgstamount: 0,
                                    igstper  : ReceiptAdjBillDetdatastore.getAt(i).get('invh_igst_per'),
                                    igstamount: 0,
                                    cdamount: 0,
                                    adjdays : 0,

                                })
                                );
                    }
//loadCDDetails();
 getAdjustmentDetails2();

       LoadInvoiceCashDiscountDetailsdatastore.removeAll();
       LoadInvoiceCashDiscountDetailsdatastore.load({
           url: 'clsBankReceipt.php',
           params: {
	        task  : 'loadInvoiceCashDiscountDetails',
                seqno : seqno,
                compcode : GinCompcode,
                crnoteseqno : crnoteseqno,
          },

          callback: function () {
              var cnt=LoadInvoiceCashDiscountDetailsdatastore.getCount();

              if (cnt>0)
              {

                     for (var j = 0; j < cnt; j++) {

                     invoiceno  = LoadInvoiceCashDiscountDetailsdatastore.getAt(j).get('dbcrt_inv_no');
                     invoiceno  =invoiceno.substring(0,13);
                     invoiceno  =invoiceno.trim();

                     cdamt  = LoadInvoiceCashDiscountDetailsdatastore.getAt(j).get('dbcrt_value');
                     cdtax  = LoadInvoiceCashDiscountDetailsdatastore.getAt(j).get('dbcrt_taxable');
                     cgst  = LoadInvoiceCashDiscountDetailsdatastore.getAt(j).get('dbcrt_cgstvalue');
                     sgst  = LoadInvoiceCashDiscountDetailsdatastore.getAt(j).get('dbcrt_sgstvalue');
                     igst  = LoadInvoiceCashDiscountDetailsdatastore.getAt(j).get('dbcrt_igstvalue');
                     cgstled  = LoadInvoiceCashDiscountDetailsdatastore.getAt(j).get('dbcrt_cgstledcode');
                     sgstled  = LoadInvoiceCashDiscountDetailsdatastore.getAt(j).get('dbcrt_sgstledcode');
                     igstled  = LoadInvoiceCashDiscountDetailsdatastore.getAt(j).get('dbcrt_igstledcode');


			flxAdjustDetails.getSelectionModel().selectAll();
			var selrows = flxAdjustDetails.getSelectionModel().getCount();
			var sel = flxAdjustDetails.getSelectionModel().getSelections();
		        reccount = 0;  
			for (var i = 0; i < selrows; i++) {

				if (sel[i].data.invno == invoiceno ) {
                                    pendamt = Number(sel[i].data.pendingamt) + Number(cdamt);

			            sel[i].set('cdvalue', cdtax);
			            sel[i].set('cgstamount', cgst);
			            sel[i].set('sgstamount', sgst);
			            sel[i].set('igstamount', igst);
			            sel[i].set('cdamount', cdamt);
	           	            sel[i].set('pendingamt', pendamt);
                    	            sel[i].set('pendingamt2', pendamt);
  
//                                    pendingamt:Ext.util.Format.number(pendamt,'0.00'),
//                                    pendingamt2:Ext.util.Format.number(pendamt,'0.00'),






		                }
		         }
                     }
                    CalcSum(); 
                       flxAccounts.getStore().removeAll();
     if (crnoteseqno > 0)
               { 


                          LoadGSTDetailsdatastore.removeAll();
     	                   LoadGSTDetailsdatastore.load({
                           url: 'clsBankReceipt.php',
	                   params: {
			        task: 'LoadInvGSTDetails',
                                seqno : crnoteseqno,
	                  },
		          callback: function () {
                              var cnt=LoadGSTDetailsdatastore.getCount();
                              if (cnt>0)
                              {


                                  for(var j=0; j<cnt; j++) 
                                  {

                                    if (LoadGSTDetailsdatastore.getAt(j).get('cust_acc_group') == 72)
                                    {  
                                   salledcode = LoadGSTDetailsdatastore.getAt(j).get('acctran_led_code');       
                                   salledname = LoadGSTDetailsdatastore.getAt(j).get('cust_name');       
                                    }
                                    if (LoadGSTDetailsdatastore.getAt(j).get('cust_acc_group') == 44 && LoadGSTDetailsdatastore.getAt(j).get('acctran_led_code') == 1644  )
                                    {  
                                   cgstledcode = LoadGSTDetailsdatastore.getAt(j).get('acctran_led_code');       
                                   cgstledname = LoadGSTDetailsdatastore.getAt(j).get('cust_name');       
                                    }
                              if (LoadGSTDetailsdatastore.getAt(j).get('cust_acc_group') == 44 && LoadGSTDetailsdatastore.getAt(j).get('acctran_led_code') == 1645  )
                                    {  
                                   sgstledcode = LoadGSTDetailsdatastore.getAt(j).get('acctran_led_code');       
                                   sgstledname = LoadGSTDetailsdatastore.getAt(j).get('cust_name');       
                                    }
                              if (LoadGSTDetailsdatastore.getAt(j).get('cust_acc_group') == 44 && LoadGSTDetailsdatastore.getAt(j).get('acctran_led_code') == 1646  )
                                    {  
                                   igstledcode = LoadGSTDetailsdatastore.getAt(j).get('acctran_led_code');       
                                   igstledname = LoadGSTDetailsdatastore.getAt(j).get('cust_name');       
                                    }
//alert(salledname);
//alert(cgstledname);

                              }
                             }
                          } 
                          });



                       flxAccounts.getStore().removeAll();
                       LoadCNOTEVouNoDetailsdatastore.removeAll();
     	               LoadCNOTEVouNoDetailsdatastore.load({
                           url: 'clsBankReceipt.php',
	                   params: {
			        task: 'LoadCreditNoteVoucherDetails',
			        fincode  : GinFinid,
			        compcode : GinCompcode,
                                cnseqno  : crnoteseqno,
	                  },
		          callback: function () {
                              var cnt1=LoadCNOTEVouNoDetailsdatastore.getCount();
                              if (cnt1>0)
                              {

                                      txtCNNo.setValue(LoadCNOTEVouNoDetailsdatastore.getAt(0).get('accref_vouno'));   
                                      txtCNRemarks.setValue(LoadCNOTEVouNoDetailsdatastore.getAt(0).get('accref_narration'));

                                   for (var jj = 0; jj < cnt1; jj++) { 


                                      var drcr = ''; 
                                      if (LoadCNOTEVouNoDetailsdatastore.getAt(jj).get('acctran_dbamt') > 0)
                                         drcr = 'Dr';
                                      else
                                         drcr = 'Cr';


 var ledgername = LoadCNOTEVouNoDetailsdatastore.getAt(jj).get('cust_name');  


                                      flxAccounts.getStore().insert(
	                                 flxDetail.getStore().getCount(),
                                         new dgrecord({
					     ledname : ledgername,                          	
			                     type    : drcr,
	                                     dbamt   : LoadCNOTEVouNoDetailsdatastore.getAt(jj).get('acctran_dbamt'),
					     cramt   : LoadCNOTEVouNoDetailsdatastore.getAt(jj).get('acctran_cramt'),  
                                             totamt  : Number(LoadCNOTEVouNoDetailsdatastore.getAt(jj).get('acctran_dbamt'))+ Number(LoadCNOTEVouNoDetailsdatastore.getAt(j).get('acctran_cramt')),
                                             ledseq  : LoadCNOTEVouNoDetailsdatastore.getAt(jj).get('acctran_led_code'), 
                                             ledtype : LoadCNOTEVouNoDetailsdatastore.getAt(jj).get('led_type'),
	                                  })
                                      );
                                    }
                                  }

                          }


           
                      });  
                 }    

                 editfind = 0;
loadCDDetails();

              }   
 
          }
      });



                    CalcSum();
            
//        RefreshGridData();

                }
            });
        } else if (flxDetail.getStore().getCount() > 1) {
            if (Number(txtTotNetAmt.getRawValue()) > Number(txtRecAmt.getRawValue())) {
                var sm = flxAdjustDetails.getSelectionModel();
                var selrow2 = sm.getSelected();
                var rcnt = flxAdjustDetails.getStore().getCount();
                for (var i = 0; i < rcnt; i++) {
                    var rec = flxAdjustDetails.getStore().getAt(i);
                    rec.set('adjamt', 0);
                    rec.set('cdvalue', 0);
                    rec.set('cgstamount', 0);
                    rec.set('sgstamount', 0);
                    rec.set('igstamount', 0);
                    rec.set('cdamount', 0);
                    rec.set('pendingamt2', selrow.get('pendingamt')); 
                }
                CalcSum();
            }
        }
    }

    function CalcSum() {

        var selrows = flxAdjustDetails.getStore().getCount();
        var ginadjtotal = 0;
        var gincdval = 0;  
        var gincdamt = 0;    

        var gincgstamt = 0;
        var ginsgstamt = 0;
        var ginigstamt = 0;   



        gstbillnos = "";
        narra = '';
        txtTotNetAmt.setValue("");
        txtRecAmt.setValue(Number(txtTotCredit.getRawValue()) - Number(txtTotDebit.getRawValue()));
        for (var i = 0; i < selrows; i++) {
            var rec = flxAdjustDetails.getStore().getAt(i);
            if (rec.get('voutype') !== "AD") {
                if (Number(rec.get('adjamt')) > 0 ) {
                    ginadjtotal = ginadjtotal + Number(rec.get('adjamt'));
                    gincdamt = gincdamt + Number(rec.get('cdamount'));

                     if (isNaN(Number(rec.get('cdvalue')))) 
                        gincdval = gincdval;

                     else
                        gincdval = gincdval + Number(rec.get('cdvalue'));

                    gincgstamt = gincgstamt   + Number(rec.get('cgstamount'));
                    ginsgstamt = ginsgstamt   + Number(rec.get('sgstamount'));
                    ginigstamt = ginigstamt   + Number(rec.get('igstamount'));


                       }

            }
        }

        var newcdamount = Number(gincdval) + Number(gincgstamt) + Number(ginsgstamt) + Number(ginigstamt);  
      
        newcdamount =  Math.round(newcdamount*100/100); 




        txtTotNetAmt.setValue(ginadjtotal);
//        txtTotCDAmt.setValue(gincdamt);
        txtTotCDAmt.setValue(newcdamount);
        txtTotCDValue.setValue(gincdval);

        txtTotCGSTAmount.setValue(gincgstamt);
        txtTotSGSTAmount.setValue(ginsgstamt);
        txtTotIGSTAmount.setValue(ginigstamt);



        if (gstFlag == "Edit" && crnoteseqno > 0 && Number(newcdamount) == 0 )
        {
             alert("You can't remove all adjustments. Because Alreday credit note generated..")
             Ext.getCmp('save').setDisabled(true); 
              

        }               
        else
        {
            if (ECreditNote == "N")
                Ext.getCmp('save').setDisabled(false);               
            else
                Ext.getCmp('save').setDisabled(true);               

        }    



       flxaccupdation(); 
    }


/*
    function RefreshGridData() {

        txtReceiptAmt.setValue("");

        txtAccountName.setValue("");
    }


 function RefreshGridData() {

        txtReceiptAmt.setValue("");
        txtAccountName.setRawValue("");
        gstFlag = "Add";
        flxLedger.hide();
        dtpVouDate.focus();

        gstrcpttype = "BANK RECEIPTS";
//        gstPaytype = "BB";


        loadLedgerListDatastore.removeAll();
        loadLedgerListDatastore.load({
            url: 'clsBankReceipt.php',
            params:
                    {
                        task      : "loadLedgerlist",
                         
                    },
                     callback : function() {  
			const input = document.getElementById('dtpVouDate');
			const end = input.value.length;
			input.setSelectionRange(0,0);
			input.focus();
                     }
        });


        HeadAccountdatastore.removeAll();
        HeadAccountdatastore.load({
            url: '/SHVPM/Accounts/clsAccounts.php',
            params:
                    {
                        task      : "cmbcashacct",
                        compcode  : GinCompcode,
                         
                    },
                     callback : function() {  HeadAccountdatastore.getCount(); 

                     cmbHeadAccount.setValue(1653);
                     }
        });

                    VouNodatastore.load({
                        url: '/SHVPM/Accounts/clsAccounts.php',
                        params:
                        {
                            task: "LoadLastVouNo",
                            finyear: GinFinid,
                            compcode: GinCompcode,
                            voutype : 'BKR'
                        },
                        callback: function(){

                                       if (GinFinid >= 24)  
                                  {    
//                                     var vno = VouNodatastore.getAt(0).get('con_value');
                                       if (VouNodatastore.getAt(0).get('con_value') < 10)
                                        {                                              
                                          vno = "00"+VouNodatastore.getAt(0).get('con_value');
                                        }                                      
                                        else
                                        {  
                                             if (VouNodatastore.getAt(0).get('con_value') < 100) 
                                             {                                              
                                              vno = "0"+VouNodatastore.getAt(0).get('con_value');                   
                                             }
                                             else 
                                             {      
                                               vno = VouNodatastore.getAt(0).get('con_value');  
                                             }
                                        } 


                                     vno =  "BKR/"+vno.slice(-4);  
                                     vno = vno.trim() +'/'+ invfin; 
  	                             txtVouNo.setValue(vno);
                                  }
                                  else
                                  {
                                      txtVouNo.setRawValue("BKR"+VouNodatastore.getAt(0).get('con_value'));
                                  } 
                        }
                    });

     

          Ledgerdatastore.load({
            url: '/SHVPM/Accounts/clsAccounts.php',
            params:
                    {
                        task: "LoadAllLedgerList",
                        compcode: GinCompcode
                    }
        });
        headcode = '2139';
        cmbVouNo.hide();
    }
*/
    var txtVouNo = new Ext.form.TextField({
        fieldLabel: '',
        id: 'txtVouNo',
        width: 120,
        name: 'txtVouNo',
        readOnly : 'true',
        enableKeyEvents: true,
        listeners: {

        }
    });


    var txtCNNo = new Ext.form.TextField({
        fieldLabel: 'Credit Note No.',
        id: 'txtCNNo',
        width: 130,
        name: 'txtCNNo',
        readOnly : 'true',
        enableKeyEvents: true,
        labelStyle : "font-size:14px;font-weight:bold;color:#0080ff",
	style: {
		    'color':'#900C3F ',readOnly:true,'text-align': 'left',
		    'style': 'Helvetica',
		    'font-size': '14px','font-weight':'bold'
		},
        listeners: {

        }
    });



function getAdjustmentDetails()
{

   var invoiceno = '';
   var adjusted = 0;
   var rowadjusted = 0;
//   flxAdjustDetails.getStore().removeAll();
       LoadAdjustmentDetailsdatastore.removeAll();
       LoadAdjustmentDetailsdatastore.load({
           url: 'clsBankReceipt.php',
           params: {
	        task  : 'LoadBillAdjustmentDetails',
                seqno : seqno,
                compcode : GinCompcode,
                crnoteseqno : crnoteseqno,
          },

          callback: function () {
              var cnt=LoadAdjustmentDetailsdatastore.getCount();

              if (cnt>0)
              {
	       Ext.getCmp("optBill").setValue(true);
               gstPaytype === "BB";	



               BillAdjustingDetail();

              }   
              else
              {
            	    Ext.getCmp("optAdv").setValue(true);
                    gstPaytype === "AD";              
              }   
          }
      });  
}   


function getAdjustmentDetails2()
{


   var invoiceno = '';
   var adjusted = 0;
   var adjusted2 = 0;
   var rowadjusted = 0;
   var rowpending = 0;
   var reccount = 0;
  //  flxAdjustDetails.getStore().removeAll();
       LoadAdjustmentDetailsdatastore.removeAll();
       LoadAdjustmentDetailsdatastore.load({
           url: 'clsBankReceipt.php',
           params: {
	        task  : 'LoadBillAdjustmentDetails',
                seqno : seqno,
                crnoteseqno : crnoteseqno,
                compcode : GinCompcode,
          },
          callback: function () {
              var cnt=LoadAdjustmentDetailsdatastore.getCount();

              if (cnt>0)
              {
      
               for(var j=0; j< cnt; j++) 
               {


   cdvalue= 0;
   taxable= 0;
   cdamt= 0;
   cgstamount= 0;
   sgstamount= 0;
   igstamount= 0;

// Annadurai




//alert(LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_ratediff'));
                        invoiceno = LoadAdjustmentDetailsdatastore.getAt(j).get('ref_invno');
                        adjusted2 = Number(LoadAdjustmentDetailsdatastore.getAt(j).get('ref_adjamount'));
	                invdate  = LoadAdjustmentDetailsdatastore.getAt(j).get('ref_invdate');




		        invamt  =  LoadAdjustmentDetailsdatastore.getAt(j).get('acctrail_inv_value');
		        crdays  =  LoadAdjustmentDetailsdatastore.getAt(j).get('acctrail_crdays');
                        grdays  =  LoadAdjustmentDetailsdatastore.getAt(j).get('acctrail_gracedays'); 
		        
                        voutype =  LoadAdjustmentDetailsdatastore.getAt(j).get('ref_adjvoutype');

		        accrefseqno =  LoadAdjustmentDetailsdatastore.getAt(j).get('ref_adjseqno');
		        accrefvouno = LoadAdjustmentDetailsdatastore.getAt(j).get('ref_adjvouno');

                        crddays = LoadAdjustmentDetailsdatastore.getAt(j).get('invh_crd_days');

                        ratediff = LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_ratediff');
                        ratediffmt = LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_ratediff');


		        PMT30dayscdamt = LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_payterm_30days_7days_receipt');


		        PMT45dayscdamt1 = LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_payterm_45days_7days_receipt');
		        PMT45dayscdamt2 = LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_payterm_45days_30days_receipt');


                        PMT60dayscdamt1 =  LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_payterm_60days_7days_receipt');
                        PMT60dayscdamt2 =  LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_payterm_60days_30days_receipt');
                        PMT60dayscdamt3 =  LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_payterm_60days_45days_receipt');


                        PMT90dayscdamt1 =  LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_payterm_90days_7days_receipt');
                        PMT90dayscdamt2 =  LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_payterm_90days_30days_receipt');
                        PMT90dayscdamt3 =  LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_payterm_90days_45days_receipt');
                        PMT90dayscdamt4 =  LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_payterm_90days_60days_receipt');
                        PMT90dayscdamt5 =  LoadAdjustmentDetailsdatastore.getAt(j).get('ordh_payterm_90days_75days_receipt');



                        if (PMT30dayscdamt > 0)
                           cdpermt = PMT30dayscdamt;


                        if (PMT45dayscdamt1 > 0)
                           cdpermt = PMT45dayscdamt1;
                        if (PMT45dayscdamt2 > 0)
                           cdpermt = PMT45dayscdamt2;


                        if (PMT60dayscdamt1 > 0)
                           cdpermt = PMT60dayscdamt1;

                        if (PMT60dayscdamt2 > 0)
                           cdpermt = PMT60dayscdamt2;

                        if (PMT60dayscdamt3 > 0)
                           cdpermt = PMT60dayscdamt3;


                        if (PMT90dayscdamt1 > 0)
                           cdpermt = PMT90dayscdamt1;
                        if (PMT90dayscdamt2 > 0)
                           cdpermt = PMT90dayscdamt2;
                        if (PMT90dayscdamt3 > 0)
                           cdpermt = PMT90dayscdamt3;

                        if (PMT90dayscdamt4 > 0)
                           cdpermt = PMT90dayscdamt4;

                        if (PMT90dayscdamt5 > 0)
                           cdpermt = PMT90dayscdamt5;



                        invwt    =  LoadAdjustmentDetailsdatastore.getAt(j).get('invwt');
                        taxable = LoadAdjustmentDetailsdatastore.getAt(j).get('invh_taxableamt')-LoadAdjustmentDetailsdatastore.getAt(j).get('invh_frt_amt');
                        cdper = LoadAdjustmentDetailsdatastore.getAt(j).get('rate_cashdisc_per');
                        cdvalue = LoadAdjustmentDetailsdatastore.getAt(j).get('dbcrt_taxable');
                        cgstper  = LoadAdjustmentDetailsdatastore.getAt(j).get('invh_cgst_per');
                        cgstamount= LoadAdjustmentDetailsdatastore.getAt(j).get('dbcrt_cgstvalue');
                        sgstper  = LoadAdjustmentDetailsdatastore.getAt(j).get('invh_sgst_per');
                        sgstamount= LoadAdjustmentDetailsdatastore.getAt(j).get('dbcrt_sgstvalue');
                        igstper  = LoadAdjustmentDetailsdatastore.getAt(j).get('invh_igst_per');
                        igstamount= LoadAdjustmentDetailsdatastore.getAt(j).get('dbcrt_igstvalue');




                        cdamt = 0;
                        cdtaxval  = LoadAdjustmentDetailsdatastore.getAt(j).get('dbcrt_taxable');
                        cdamt  = LoadAdjustmentDetailsdatastore.getAt(j).get('dbcrt_value');

                        rowadjusted = 0;  
                        rowpending= 0;  

			flxAdjustDetails.getSelectionModel().selectAll();
			var selrows = flxAdjustDetails.getSelectionModel().getCount();
			var sel = flxAdjustDetails.getSelectionModel().getSelections();
                        reccount = 0;  

        dtpInvDate.setValue(Ext.util.Format.date(invdate, "Y-m-d"));

        var dt_inv = dtpInvDate.getValue();


        var dt_coll = dtpRefDate.getValue();

        var diffdays = dt_coll.getTime()-dt_inv.getTime();
        diffdays = Math.ceil(diffdays / (1000 * 60 * 60 * 24)); 

        diffdays = diffdays - Number(txtAddnlCDDays.getValue());  
        var PTGD = Number(crdays) + Number(grdays);
        var cdpermt_new = 0;
        if (PTGD <= 7 )
           cdpermt_new = 0;
        if (PTGD == 30 && diffdays < 11)
           cdpermt_new = PMT30dayscdamt;
        else if (PTGD == 45 && diffdays < 11)
           cdpermt_new = PMT45dayscdamt1;
        else if (PTGD == 45 && diffdays <= 35)
           cdpermt_new = PMT45dayscdamt2;
        else if (PTGD == 60 && diffdays < 11)
           cdpermt_new = PMT60dayscdamt1;
        else if (PTGD == 60 && diffdays <= 35)
           cdpermt_new = PMT60dayscdamt2;
        else if (PTGD == 60 && diffdays <= 45)
           cdpermt_new = PMT60dayscdamt3;
        else if (PTGD == 90 && diffdays < 11)
           cdpermt_new = PMT60dayscdamt1;
        else if (PTGD == 90 && diffdays <= 35)
           cdpermt_new = PMT60dayscdamt2;
        else if (PTGD == 90 && diffdays <= 45)
           cdpermt_new = PMT60dayscdamt3;
        else if (PTGD == 90 && diffdays <= 60)
           cdpermt_new = PMT60dayscdamt4;
        else if (PTGD == 90 && diffdays <= 75)
           cdpermt_new = PMT90dayscdamt5;

			for (var i = 0; i < selrows; i++) {

			        if (sel[i].data.invno == invoiceno ) {



		                    rowadjusted = Number(sel[i].data.adjamt) + Number(adjusted2) ;
		 //                   rowpending = Number(sel[i].data.pendingamt) + Number(adjusted);
	                           rowpending = Number(sel[i].data.pendingamt) ;
		                    sel[i].set('adjamt', rowadjusted);
		                    sel[i].set('pendingamt', rowpending);
		                    sel[i].set('cdvalue', cdtaxval);
		                    sel[i].set('taxable', cdtaxval);
		                    sel[i].set('cdmt', cdpermt_new);
		                    reccount = reccount+1;
				}
                        }




		        if  (reccount == 0 )
		        {  


                        var RowCnt = flxAdjustDetails.getStore().getCount()+1 ;

		        flxAdjustDetails.getStore().insert(
		                flxAdjustDetails.getStore().getCount(),
		                new dgrecord2({
		                    invno: invoiceno,
		                    invdate: invdate,

		                    invdate2:   Ext.util.Format.date(invdate, "d-m-Y"),

		                    invamt: invamt,
		                    payterms: crdays,
		                    totamt: invamt,
		                    pendingamt: adjusted ,
		                    pendingamt2: adjusted ,

		                    adjamt: adjusted2,
		                    voutype: voutype,
	

		                    accrefseqno: accrefseqno,
		                    accrefvouno: accrefvouno,
                                    PMT30dayscdamt: PMT30dayscdamt,
                                    crddays: crddays,
                                    grdays : grdays,
                                    ratediff: ratediff,
                                    invwt: invwt,
                                    taxable: taxable,
                                    cdper: cdper,

                                    cdvalue : cdtaxval,
                                    cgstper  : cgstper,
                                    cgstamount: cgstamount,
                                    sgstper  : sgstper,
                                    sgstamount: sgstamount,
                                    igstper  : igstper,
                                    igstamount: igstamount,
                                    cdamount: cdamt,

		                    PMT45dayscdamt1 :PMT45dayscdamt1,
		                    PMT45dayscdamt2 :PMT45dayscdamt2,


                                    PMT60dayscdamt1: PMT60dayscdamt1,
                                    PMT60dayscdamt2: PMT60dayscdamt2,
                                    PMT60dayscdamt3: PMT60dayscdamt3,

                                    PMT90dayscdamt1: PMT90dayscdamt1,
                                    PMT90dayscdamt2: PMT90dayscdamt2,
                                    PMT90dayscdamt3: PMT90dayscdamt3,
                                    PMT90dayscdamt4: PMT90dayscdamt4,
                                    PMT90dayscdamt5: PMT90dayscdamt5,
                                    cdmt           : cdpermt_new,


		                })
		                );

adjusted = 0;

		                CalcSum();
		        }
                        grid_move();
	                CalcSum();

		}



              } 
/*  
              else
              {
            	    Ext.getCmp("optAdv").setValue(true);
                    gstPaytype === "AD";              
              }  
*/ 
          }
      });  
}   

  

    var cmbVouNo = new Ext.form.ComboBox({
        fieldLabel: '',
        width: 120,
        store: Voucherdatastore,
        displayField: 'vou_no',
        valueField: 'vou_seqno',
        hiddenName: 'vou_no',
        id: 'cmbVouNo',
        typeAhead: true,
        mode: 'local',
        forceSelection: false,
        triggerAction: 'all',
        selectOnFocus: false,
        editable: true,
        allowblank: false,
        listeners:{
           select: function(){

               //        Ext.getCmp('editchk').show();

                       ECreditNote = "N";
                       flxAdjustDetails.getStore().removeAll();
                       flxAccounts.getStore().removeAll();
                       flxDetail.getStore().removeAll();
                       LoadVouNoDetailsdatastore.removeAll();
     	               LoadVouNoDetailsdatastore.load({
                           url: 'clsBankReceipt.php',
	                   params: {
			        task: 'LoadBRVoucherDetails',
			        fincode : GinFinid,
			        compcode: GinCompcode,
                                vouno   : cmbVouNo.getRawValue(),
	                  },
		          callback: function () {
                              var cnt=LoadVouNoDetailsdatastore.getCount();
                              if (cnt>0)
                              {

                                  editfind = 0;

                                  crnoteseqno  = LoadVouNoDetailsdatastore.getAt(0).get('accref_link_seqno');


txtAccountName.setRawValue(LoadVouNoDetailsdatastore.getAt(0).get('cust_name'));
txtReceiptAmt.setRawValue(LoadVouNoDetailsdatastore.getAt(0).get('acctran_cramt'));
      
      
                                      ledtype = LoadVouNoDetailsdatastore.getAt(0).get('cust_type');
                                      ledgercode = LoadVouNoDetailsdatastore.getAt(0).get('acctran_led_code');
                                      partycode = LoadVouNoDetailsdatastore.getAt(0).get('acctran_led_code');


                                  for(var j=0; j<cnt; j++) 
                                  {
           
//alert(LoadVouNoDetailsdatastore.getAt(j).get('acctran_led_code'));

                                      if (Number(LoadVouNoDetailsdatastore.getAt(j).get('cust_acc_group')) == 42)
                                        cmbHeadAccount.setValue(LoadVouNoDetailsdatastore.getAt(j).get('acctran_led_code'));
//                                      else                                             

                                      seqno =  LoadVouNoDetailsdatastore.getAt(j).get('accref_seqno');
                                      txtVouNo.setRawValue(cmbVouNo.getRawValue());

      
                                      cmbPaymode.setRawValue(LoadVouNoDetailsdatastore.getAt(j).get('accref_paymode'));
                                      dtpVouDate.setRawValue(Ext.util.Format.date(LoadVouNoDetailsdatastore.getAt(j).get('accref_voudate'),"d-m-Y"));  
                                      txtRefNo.setRawValue(LoadVouNoDetailsdatastore.getAt(j).get('accref_payref_no'));
                                      dtpRefDate.setRawValue(Ext.util.Format.date(LoadVouNoDetailsdatastore.getAt(j).get('accref_payref_date'),"d-m-Y")); 
                                      txtNarration.setRawValue(LoadVouNoDetailsdatastore.getAt(j).get('accref_narration'));
                                      txtBankName.setRawValue(LoadVouNoDetailsdatastore.getAt(j).get('accref_bank_name'));
                                      var drcr = ''; 
                                      if (LoadVouNoDetailsdatastore.getAt(j).get('acctran_dbamt') > 0)
                                         drcr = 'Dr';
                                      else
                                         drcr = 'Cr';



                                      if (Number(LoadVouNoDetailsdatastore.getAt(j).get('acctran_cramt')) >0)

                                      {
                                      ledtype = LoadVouNoDetailsdatastore.getAt(j).get('cust_type');
		                          flxDetail.getStore().insert(
			                  flxDetail.getStore().getCount(),
		                          new dgrecord({
					     ledname : LoadVouNoDetailsdatastore.getAt(j).get('cust_name'),           
                                             type    : drcr,
			                     dbamt   : LoadVouNoDetailsdatastore.getAt(j).get('acctran_dbamt'),
					     cramt   : LoadVouNoDetailsdatastore.getAt(j).get('acctran_cramt'),  
		                             totamt  : Number(LoadVouNoDetailsdatastore.getAt(j).get('acctran_dbamt'))+ Number(LoadVouNoDetailsdatastore.getAt(j).get('acctran_cramt')),
		                             ledseq  : LoadVouNoDetailsdatastore.getAt(j).get('acctran_led_code'), 
		                             ledtype : LoadVouNoDetailsdatastore.getAt(j).get('cust_type'),
			                   })
		                           );
                                      }
                                  }


if (crnoteseqno > 0)
    Ext.getCmp('optPayType').setDisabled(true);  
else
    Ext.getCmp('optPayType').setDisabled(false);  



               CalcTotalDebitCredit();
               getAdjustmentDetails();
               EditDateCheck();


                            if (crnoteseqno  > 0)
                            {




		               loadECNStatus.removeAll();
	     	               loadECNStatus.load({
		                   url: 'clsBankReceipt.php',
			           params: {
					task: 'check_e_credit_note_status',
					fincode  : GinFinid,
					compcode : GinCompcode,
		                        cnseqno  : crnoteseqno,
			          },
				  callback: function () {
		                      var cnt=loadECNStatus.getCount();
		                      if (cnt>0)
		                      {
		                              if (loadECNStatus.getAt(0).get('E_inv_confirm') == "Y")
		                              {  
		                       alert("E-Credit Note Already generated. You can't Modify this Bank Receipt...");
		                       Ext.getCmp('save').setDisabled(true);  
                       ECreditNote = "Y";

		                              }
		                              else
		                              {     
		                               Ext.getCmp('save').setDisabled(false);    
		                              }   
                                       }           
                                  }   
                               });   



                            }
                            else
                            {    

                               Ext.getCmp('save').setDisabled(false);    
                            }   



        


                 }
                          }
                      });  
            }    
        }

    });

    var lblPayMode = new Ext.form.Label({
        fieldLabel: 'Payment Mode',
        id: 'lblPayMode',
        width: 100,
        labelStyle  : "font-size:13px;font-weight:bold;color:#fc9403",
    });


    var lblRefNo = new Ext.form.Label({
        fieldLabel: 'Ref.No.',
        id: 'lblRefNo',
        width: 80,
        labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });

    var lblRefDate = new Ext.form.Label({
        fieldLabel: 'Ref. Date.',
        id: 'lblRefDate',
        width: 100,
        labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });


    var lblBank = new Ext.form.Label({
        fieldLabel: 'Party Bank Name.',
        id: 'lblBank',
        width: 100,
        labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });


    var lblVouNo = new Ext.form.Label({
        fieldLabel: 'Vou. No.',
        id: 'lblVouNo',
        width: 100,
        labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });

    var lblVouDate = new Ext.form.Label({
        fieldLabel: 'Vou.Date',
        id: 'lblVouDate',
        width: 50,
        labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });

    var lblHeadAcnt = new Ext.form.Label({
        fieldLabel: 'Bank.Account',
        id: 'lblHeadAcnt', 
        width: 100,
        labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });


    var cmbAccountName = new Ext.form.ComboBox({
        fieldLabel: '',
        width: 360,
        store: loadLedgerListDatastore,
        displayField: 'cust_name',
        valueField: 'cust_code',
        hiddenName: 'cust_name',
        id: 'cmbAccountName',
        typeAhead: true,
        mode: 'local',
        forceSelection: true,
        triggerAction: 'all',
        selectOnFocus: true,
        editable: true,
        allowblank: false,
        listeners: {
          specialkey:function(f,e){
             if (e.getKey() == e.ENTER)
             {
          
             }
          },
          select: function () {
            }
        }
    });

    var cmbHeadAccount = new Ext.form.ComboBox({
        fieldLabel: '',
        width: 300,
        store: HeadAccountdatastore,
        displayField: 'cust_name',
        valueField: 'cust_code',
        hiddenName: 'cust_name',
        id: 'cmbHeadAccount',
        typeAhead: true,
        mode: 'local',
        forceSelection: true,
        triggerAction: 'all',
        selectOnFocus: true,
        editable: true,
        allowblank: false,
        listeners: {
          specialkey:function(f,e){
             if (e.getKey() == e.ENTER)
             {
                   txtAccountName.focus();
             }
          },
            select: function () {
                if (cmbHeadAccount.getRawValue() === txtAccountName.getRawValue() && cmbHeadAccount.getRawValue()!=="") {
                    Ext.MessageBox.show({
                        title: 'Alert',
                        icon: Ext.Msg.QUESTION,
                        buttons: Ext.MessageBox.YESNO,
                        msg: 'Same Head Account and AccName!',
                        fn: function (btn) {
                            if (btn === 'yes') {
                                cmbHeadAccount.setRawValue("");
                                cmbHeadAccount.focus();
                            } else {
                                cmbHeadAccount.setRawValue("");
                                cmbHeadAccount.focus();
                            }
                        }
                    });
                }
            }, blur: function () {
                if (cmbHeadAccount.getRawValue() === txtAccountName.getRawValue() && cmbHeadAccount.getRawValue()!== "") {
                    Ext.MessageBox.show({
                        title: 'Alert',
                        icon: Ext.Msg.QUESTION,
                        buttons: Ext.MessageBox.YESNO,
                        msg: 'Same Head Account and AccName!',
                        fn: function (btn) {
                            if (btn === 'yes') {
                                cmbHeadAccount.setRawValue("");
                                cmbHeadAccount.focus();
                            } else {
                                cmbHeadAccount.setRawValue("");
                                cmbHeadAccount.focus();
                            }
                        }
                    });
                }
            }
        }
    });

    var optPayType = new Ext.form.RadioGroup({
        title: 'Pay Type',
        columns: 2,
        rows :1,
        id: 'optPayType',
        layout: 'hbox',
        width: 200,
        height :40,
        x: 20,
        y: 15,
        defaults: {xtype: "radio", name: "OptType"},
        items: [
            {boxLabel: 'Against Bills', id: 'optBill', inputValue: 1,checked: true,
                listeners: {
                    'check': function (rb, checked) {
                        if (checked === true) {
                            txtTotNetAmt.setValue(''); 
                            txtTotCDAmt.setValue('');
                            txtDebitTotal.setValue('');
                            txtCreditTotal.setValue('');
                            txtTotCGSTAmount.setValue('');
                            txtTotSGSTAmount.setValue('');
                            txtTotIGSTAmount.setValue('');
                            rounding = 0;

                            gstPaytype = "BB";
                            flxAdjustDetails.getStore().removeAll();
                            flxAccounts.getStore().removeAll();
                            BillAdjustingDetail();

                        }
                    }
                }
            },
            {boxLabel: 'Advance', id: 'optAdv', inputValue: 2, 
                listeners: {
                    'check': function (rb, checked) {
                        if (checked === true) {

                            txtTotNetAmt.setValue('0'); 
                            txtTotCDAmt.setValue('0'); 
                            txtDebitTotal.setValue('');
                            txtCreditTotal.setValue('');
                            txtTotCGSTAmount.setValue('');
                            txtTotSGSTAmount.setValue('');
                            txtTotIGSTAmount.setValue('');
                            rounding = 0;

                            gstPaytype = "AD";
                            flxAdjustDetails.getStore().removeAll();
                            flxAccounts.getStore().removeAll();
                        }
                    }
                }
            }
        ]
    });

    var ledgertype = 'A';
    var optLedType = new Ext.form.RadioGroup({
        title: 'Ledger Type',
        columns: 2,
        rows :1,
        id: 'optLedType',
        layout: 'hbox',
        width: 200,
        height :40,
        x: 20,
        y: 15,
        defaults: {xtype: "radio", name: "optLedType"},
        items: [
            {boxLabel: 'Customer', id: 'optCust', inputValue: 1,checked: true,
                listeners: {
                    'check': function (rb, checked) {
                        if (checked === true) {
                            ledgertype = 'C';
                        }
                    }
                }
            },
            {boxLabel: 'All', id: 'optAllLedger', inputValue: 2, 
                listeners: {
                    'check': function (rb, checked) {
                        if (checked === true) {
                              ledgertype = 'A';
                        }
                    }
                }
            }
        ]
    });

    var cdtype = 'Y';

    var optCDType = new Ext.form.RadioGroup({
        title: 'CD Type',
        columns: 2,
        rows :1,
        id: 'optCDType',
        layout: 'hbox',
        width: 190,
        height :30,
        x: 20,
        y: 15,
        defaults: {xtype: "radio", name: "optCDType"},
        items: [
            {boxLabel: 'yes (default)', id: 'optCDYes', inputValue: 1,checked: true,
                listeners: {
                    'check': function (rb, checked) {
                        if (checked === true) {
                           cdtype = 'Y';
                        }
                    }
                }
            },
            {boxLabel: 'No', id: 'optCDNo', inputValue: 2, 
                listeners: {
                    'check': function (rb, checked) {
                        if (checked === true) {
                           cdtype = 'N';
                        }
                    }
                }
            }
        ]
    });


    var dateon;
    var getdate;


  function NewDateCheck()
  {
        var dt_today = new Date();
        var dt_voucher = dtpVouDate.getValue();

        var diffdays = dt_today.getTime()-dt_voucher.getTime();
        diffdays = Math.ceil(diffdays / (1000 * 60 * 60 * 24)); 

        if (diffdays > (GinNewDays+1))
        {     
             alert("You are Not Allowed to Raise the document in the date of " +  Ext.util.Format.date(dt_voucher,"d-m-Y"));
             dtpVouDate.setRawValue(Ext.util.Format.date(dt_today,"d-m-Y"));

        }
        if (diffdays <= 0)
        {     
             alert("System will not allow to raise the document in Future date");
             dtpVouDate.setRawValue(Ext.util.Format.date(dt_today,"d-m-Y"));

        }

    if(Ext.util.Format.date(dtpVouDate.getValue(),"Y-m-d") > Ext.util.Format.date(finenddate,"Y-m-d")){
            Ext.MessageBox.alert("Alert","Document Date is not in current finance year. Please check");
    }

    dtpRefDate.setRawValue(dtpVouDate.getRawValue());

 }


  function EditDateCheck()
  {
        var dt_today = new Date();
        var dt_voucher = dtpVouDate.getValue();

        var diffdays = dt_today.getTime()-dt_voucher.getTime();
        diffdays = Math.ceil(diffdays / (1000 * 60 * 60 * 24)); 

        if (diffdays > (GinEditDays+1))
        {     
             alert("You are Not Allowed to Modify this document. Contact HOD for Corrections.." );
             Ext.getCmp('save').setDisabled(true);  
        }
        else
        {
             Ext.getCmp('save').setDisabled(false);  

        }       
 }




    var dtpVouDate= new Ext.form.DateField({
        fieldLabel: '',
        id: 'dtpVouDate',
        name: '',
        format: 'd-m-Y',
        value: new Date(),
    	labelStyle	: "font-size:12px;font-weight:bold;",
    	style      :"border-radius: 5px;  textTransform: uppercase ", 
       	enableKeyEvents: true,
        listeners:{
           blur:function(){
              NewDateCheck();
           },
           keyup:function(){
              NewDateCheck();
          },
          specialkey:function(f,e){

             if (e.getKey() == e.ENTER)
             {
                   txtAccountName.focus();
             }
          },
        }  	
        
    });

    var dtpInvDate= new Ext.form.DateField({
        fieldLabel: '',
        id: 'dtpInvDate',
        name: '',
        format: 'd-m-Y',
        value: new Date(),
    	labelStyle	: "font-size:12px;font-weight:bold;",
    	style      :"border-radius: 5px;  textTransform: uppercase ", 
       	enableKeyEvents: true,
        listeners:{
        }  	
        
    });


    var lblAccount = new Ext.form.Label({
        fieldLabel: 'Ledger Name' ,
        id: 'lblAccount',
        width: 50,
        labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });


var txtAccountName = new Ext.form.TextField({
        fieldLabel  : '',
        id          : 'txtAccountName',
        name        : 'txtAccountName',
        width       :  400,
        labelStyle : "font-size:14px;font-weight:bold;color:#0080ff",
    	style      :"border-radius: 5px;textTransform: uppercase; ", 
	enableKeyEvents: true,
	listeners:{
          specialkey:function(f,e){
             if (e.getKey() == e.ESC)
             {
                flxLedger.hide();
             }
             if (e.getKey() == e.ENTER)
             {
                 if (ledgercode == 0)
                 {    
                    alert("Select Ledger Name ...");
                    txtAccountName.focus();
                 }
                 else
                 {    
		        flxDetail.getStore().removeAll();
		        flxAdjustDetails.getStore().removeAll();
		        txtReceiptAmt.focus();
		        BillAdjustingDetail();
                 } 


             }
             if (e.getKey() == e.DOWN)
             {
 
             flxLedger.getSelectionModel().selectRow(0)
             flxLedger.focus;
             flxLedger.getView().focusRow(0);
             }
             if (e.getKey() == e.UP)
             {
 
              txtAccountName.focus;
             }
          },
	    keyup: function () {
//                Ext.WindowManager.bringToFront('flxLedger');
                flxLedger.getEl().setStyle('z-index','10000');
                flxLedger.show();
                loadSearchLedgerListDatastore.removeAll();
                  if (txtAccountName.getRawValue() != '')
                     LedgerSearch();
            }
         }  
    });






    var lblAmt = new Ext.form.Label({
        fieldLabel: 'Amount',
        id: 'lblAmt',hidden:true,
        width: 50,
        labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });

    var txtAmt = new Ext.form.NumberField({
        fieldLabel: '',
        id: 'txtAmt',hidden:true,
        width: 70,
        name: 'Amount',
        disabled: true
    });

    var lblExgRate = new Ext.form.Label({
        fieldLabel: 'Exg.Rate',
        id: 'lblExgRate',hidden:true,
        width: 50
    });



    var lblReceipt = new Ext.form.Label({
        fieldLabel: 'Receipt Amount',
        id: 'lblReceipt',
        width: 50,
        labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });
 var txtUserName = new Ext.form.TextField({
        fieldLabel: 'Login By ',
        id: 'txtUserName',
        width: 100,
        name: 'txtUserName',
        enableKeyEvents: true,
        readOnly : true,
        listeners: {
        }
    });

    var txtReceiptAmt = new Ext.form.NumberField({
        fieldLabel: '',
        id: 'txtReceiptAmt',
        width: 100,
        name: 'Credit',
        disabled: true,
        enableKeyEvents: true,
	style: {
		    'color':'#900C3F ',readOnly:true,'text-align': 'right',
		    'style': 'Helvetica',
		    'font-size': '14px','font-weight':'bold'
		},
        listeners:{
             specialkey:function(f,e){
             if (e.getKey() == e.ENTER)
             {
    //              btnAdd.focus();
                add_btn_click();
             }
          }
       
        }    
    });

    var txtAddnlCDDays = new Ext.form.NumberField({
        fieldLabel: 'Additional CD Days',
        id: 'txtAddnlCDDays',
        width: 40,
        name: 'txtAddnlCDDays',
        disabled: true,
        enableKeyEvents: true,
	style: {
		    'color':'#900C3F ',readOnly:true,'text-align': 'right',
		    'style': 'Helvetica',
		    'font-size': '14px','font-weight':'bold'
		},
        labelStyle : "font-size:14px;font-weight:bold;color:#0080ff",
        listeners:{

       
        }    
    });

    var btnAdd = new Ext.Button({
        style: 'text-align:center;',
        text: "Add",
        width: 80,
        id : 'btnAdd',
        x: 580,
        y: 20,
          border: 1,
          style: {
              borderColor: 'blue',
              borderStyle: 'solid',
              fontSize  : '14px',

          },
        listeners: {
            click: function () {
                add_btn_click();

        }
       }  
    });

    var btnClearAdj = new Ext.Button({
        style: 'text-align:center;',
        text: "R",
        width: 40,
        x: 720,
        y: 30,
          border: 1,
          style: {
              borderColor: 'blue',
              borderStyle: 'solid',
              fontSize  : '14px',

          },
        listeners: {
        click: function () {
		var selrows = flxAdjustDetails.getStore().getCount();
                var pamt = 0;
	//	txtRecAmt.setValue(Number(txtTotCredit.getRawValue()) - Number(txtTotDebit.getRawValue()));

                for (var k = 0 ; k <2;k++) {
		for (var i = 0; i < selrows; i++) {
		    var rec = flxAdjustDetails.getStore().getAt(i);
		    if (rec.get('voutype') !== "AD") {

                            pamt =   Number(rec.get('pendingamt')) + Number(rec.get('adjamt')); 
                            if ( Number(pamt) >  Number(rec.get('invamt')))
                               pamt = Number(rec.get('invamt'));
		            rec.set('pendingamt',pamt);
		            rec.set('pendingamt2',pamt);
  		            rec.set('adjamt',0);
                            rec.set('cdamount', "0");
                            rec.set('cdvalue', 0);
                            rec.set('cgstamount', 0);
                            rec.set('sgstamount', 0);
                            rec.set('igstamount', 0);
                            rec.set('cdamount', 0);
		            rec.set('adjamt',0);
		    }
		}
                }
                CalcSum();
     }
        }
    });

 var dgrecord = Ext.data.Record.create([]);


    var flxDetail = new Ext.grid.EditorGridPanel({
        frame: false,
        store: AccountDetDataStore,
        sm: new Ext.grid.RowSelectionModel(),
        autoShow: true,
        stripeRows : true,
        scrollable: true,
        height: 0,
        width: 0,
        id: 'my-grid',  
        x: 10,
        y: 60,
        columns: [         
            {header: "Account Name", dataIndex: 'ledname', sortable: true, width: 350, align: 'left'},
            {header: "Debit", dataIndex: 'dbamt', sortable: true, width: 60, align: 'right',hidden: true},
            {header: "Credit", dataIndex: 'cramt', sortable: true, width: 120, align: 'right'},
            {header: "Ledseqno", dataIndex: 'ledseq', sortable: true, width: 40, align: 'left', hidden: false},
            {header: "totamt", dataIndex: 'totamt', sortable: true, width: 60, align: 'right',hidden: false},
            {header: "ledtype", dataIndex: 'ledtype', sortable: true, width: 60, align: 'left'},
        ],
        store:[],

    listeners:{	
        'cellclick' : function(flxDesc, rowIndex, cellIndex, e){
         Ext.Msg.show({
             title: 'BANK RECEIPT ENTRY',
             icon: Ext.Msg.QUESTION,
             buttons: Ext.MessageBox.YESNOCANCEL,
             msg: 'Press YES to Modify   -  NO to Delete - CANCEL to EXIT',
             fn: function(btn){
        	if (btn === 'yes'){
                    var sm = flxDetail.getSelectionModel();
		    var selrow = sm.getSelected();
                    gridedit = "true";
		    editrow  = selrow;
                    txtAccountName.setRawValue(selrow.get('ledname'));
  ledgercode = selrow.get('ledseq');
                   // ledgercode.setValue(selrow.get('ledseq'));
                    txtReceiptAmt.setValue(selrow.get('cramt'));
                    ledtype =  selrow.get('ledtype');

                      Ext.getCmp('btnAdd').setDisabled(false);  
                    flxDetail.getSelectionModel().clearSelections();

		}
                   else if (btn === 'no'){
                        var sm = flxDetail.getSelectionModel();
                        var selrow = sm.getSelected();
                        flxDetail.getStore().remove(selrow);
                        flxDetail.getSelectionModel().selectAll();
                   }
         CalcTotalDebitCredit();
             }
        });         
    }
   }




    });




function grid_move() {

            var cdvalue1 = 0;
            var totcdqty = 0;
            var totcdvalue = 0;
            var invlist = '';
   flxCD.getStore().removeAll();


    let CDStore = flxCD.getStore();

    flxAdjustDetails.getSelectionModel().selectAll();
    var sel = flxAdjustDetails.getSelectionModel().getSelections();

    for (var i = 0; i < sel.length; i++) {
        var recData = sel[i].data;

        if (Number(recData.cdamount ) >0) {
            var exists = false;

            // Check if the record already exists in the final store
            for (var j = 0; j < CDStore.getCount(); j++) {
                var existing = CDStore.getAt(j);
                if (Number(existing.get('cdpmt')) == Number(recData.cdmt)) {
                    if ( Number(recData.adjamt) > 0)
                    { 
                    totcdqty = Number(existing.get('qty')) +  Number(recData.invwt);
                    totcdvalue = Number(totcdqty) * (Number(recData.cdmt)+ Number(recData.ratediff));
                    } 
                    exists = true;
                    break;
                }
            }


            if (!exists) {
                // Add record to final store
                cdvalue1 = (Number(recData.cdmt)+ Number(recData.ratediff)) * Number(recData.invwt);
                cdvalue1 =    Ext.util.Format.number(Number(cdvalue1), '0.00') ;                
  
                var iwt =    totinvwt =  Ext.util.Format.number(recData.invwt,'0.000');   

                CDStore.add(new dgrecord({
                    cdpmt    : Number(recData.cdmt),
                    ratediff : Number(recData.ratediff),
                    qty      : iwt,
                    invno    : recData.invno,
                    CDValue  : cdvalue1 ,
                }));
            }
            else
            {

                    invlist = existing.get('invno') + ',' + recData.invno;   
                    existing.set('qty', totcdqty.toFixed(3) );
                    existing.set('CDValue', totcdvalue.toFixed(2) );
                    existing.set('invno',invlist  );
            }          

        }
    }




/*
    // Re-select all rows to ensure correct selection (could be optimized out if not needed)
    flxDebit.getSelectionModel().selectAll();
    var sel = flxDebit.getSelectionModel().getSelections();

    for (var i = 0; i < sel.length; i++) {
        var recData = sel[i].data;


            var exists = false;

            // Check if the record already exists in the final store
            for (var j = 0; j < finalStore.getCount(); j++) {
                var existing = finalStore.getAt(j);
                if (
                     existing.get('invdocno') === recData.acctrail_inv_no
                ) {
                    var balamt   = Number(recData.pendingamt) - Number(recData.adjamt);
                    var invamt   = Number(recData.acctrail_inv_value) ;
                    var pendamt  = Number(recData.pendingamt);
                    var adjamt   = Number(recData.adjamt);
                    var cdval    =  0;
                    var cgst     =  0;
                    var sgst     =  0;
                    var cdamount =  0;
 
                    if (balamt == 0)
                    { 
                       cdval = Number(recData.invqty) * 500;
                       cgst  = cdval * 0.06;
                       sgst  = cdval * 0.06;

                       cdval = cdval.toFixed(2);
                       cgst  = cgst.toFixed(2);
                       sgst  = sgst.toFixed(2);
                       cdamount = Number(cdval) + Number(cgst) + Number(sgst);

                    }
                    existing.set('invbalance', balamt.toFixed(2) );
                    existing.set('acctrail_inv_value', invamt.toFixed(2) );
                    existing.set('pendingamt', pendamt.toFixed(2) );
                    existing.set('adjusted', adjamt.toFixed(2) );
                    existing.set('cdvalue', cdval);
                    existing.set('cgst', cgst);
                    existing.set('sgst', sgst);
                    existing.set('cdamount', cdamount );
                    exists = true;
                    break;
                }
            }

    }


*/;
}

var flxCD = new Ext.grid.EditorGridPanel({
        frame: false,
        sm: new Ext.grid.RowSelectionModel(),
        autoShow: true,
        stripeRows : true,
        scrollable: true,
        height: 160,
        width: 470,
        id: 'my-grid',  
	x:780,
	y:140,
        columns: [         
            {header: "CD PMT", dataIndex: 'cdpmt', sortable: true, width: 70, align: 'left'},
            {header: "Rate Diff", dataIndex: 'ratediff', sortable: true, width: 80, align: 'right'},
            {header: "Qty", dataIndex: 'qty', sortable: true, width: 60, align: 'right'},
            {header: "Value", dataIndex: 'CDValue', sortable: true, width: 90, align: 'right',hidden: false},
            {header: "Inv Nos.", dataIndex: 'invno', sortable: true, width: 600, align: 'left', hidden: false},

        ],
        store:[],

    listeners:{	
    }
 });




    var txttotCDQty = new Ext.form.NumberField({
        fieldLabel: 'Total CD Qty',
        id: 'txttotCDQty',
        width: 80,
        name: 'txttotCDQty',
        readOnly : true,
        labelStyle   : "font-size:14px;font-weight:bold;color:#0080ff",
	style: {
		    'color':'#900C3F ',readOnly:true,'text-align': 'right',
		    'style': 'Helvetica',
		    'font-size': '14px','font-weight':'bold'
		},
    });

    var txttotCDValue = new Ext.form.NumberField({
        fieldLabel: ' Total CD Value',
        id: 'txttotCDValue',
        width: 100,
        name: 'txttotCDValue',
        readOnly : true,
        labelStyle   : "font-size:14px;font-weight:bold;color:#0080ff",

	style: {
		    'color':'#900C3F ',readOnly:true,'text-align': 'right',
		    'style': 'Helvetica',
		    'font-size': '14px','font-weight':'bold'
		},
    });




    var txtDebitTotal = new Ext.form.NumberField({
        fieldLabel: 'Debit Total',
        id: 'txtDebitTotal',
        width: 100,
        name: 'txtDebitTotal',
        readOnly : true,
        labelStyle   : "font-size:14px;font-weight:bold;color:#0080ff",
	style: {
		    'color':'#900C3F ',readOnly:true,'text-align': 'right',
		    'style': 'Helvetica',
		    'font-size': '14px','font-weight':'bold'
		},
    });

    var txtCreditTotal = new Ext.form.NumberField({
        fieldLabel: 'Credit Total',
        id: 'txtCreditTotal',
        width: 100,
        name: 'txtCreditTotal',
        readOnly : true,
        labelStyle   : "font-size:14px;font-weight:bold;color:#0080ff",

	style: {
		    'color':'#900C3F ',readOnly:true,'text-align': 'right',
		    'style': 'Helvetica',
		    'font-size': '14px','font-weight':'bold'
		},
    });


    var txtTotDebit = new Ext.form.NumberField({
        fieldLabel: 'Debit', readOnly: true,
        id: 'txtTotDebit',
        width: 80,
        name: 'TotDebit',
	style: {
		    'color':'#900C3F ',readOnly:true,'text-align': 'right',
		    'style': 'Helvetica',
		    'font-size': '14px','font-weight':'bold'
		},
    });

    var txtTotCredit = new Ext.form.NumberField({
        fieldLabel: 'Total Credit', readOnly: true,
        id: 'txtTotCredit',
        width: 100,
        name: 'TotCredit',
	style: {
		    'color':'#900C3F ',readOnly:true,'text-align': 'right',
		    'style': 'Helvetica',
		    'font-size': '14px','font-weight':'bold'
		},
    });

    var txtRefNo = new Ext.form.TextField({
        fieldLabel: 'Ref. No',
        id: 'txtRefNo',
        width: 200,
        name: 'RefNo',
        enableKeyEvents: true,
        style: {textTransform: "uppercase"},
        labelStyle : "font-size:14px;font-weight:bold;color:#0080ff",
       autoCreate:{tag:'input',type:'text',size:'20',autocomplete:'off',maxlength:'29'},
    });

    var txtRefBills = new Ext.form.TextField({
        fieldLabel: '',
        id: 'txtRefBills',
        width: 2000,
        name: 'txtRefBills',
        enableKeyEvents: true,
        style: {textTransform: "uppercase"}
    });

    var dtpRefDate = new Ext.form.DateField({
        fieldLabel: 'Ref Date',
        id: 'dtpRefDate',
        name: 'RefDate',
        format: 'd-m-Y',
        value: new Date(),
	//value: '2020-03-31',
    //    anchor: '100%',
        width: 100,
        labelStyle : "font-size:14px;font-weight:bold;color:#0080ff",
 	enableKeyEvents: true,
        listeners   :{
/*
          change: function (obj, newValue) {
            loadCDDetails();
          },
           blur:function(){
              loadCDDetails();
           },
           keyup:function(){
              loadCDDetails();
           },
*/
        }

    });

    var txtRecAmt = new Ext.form.NumberField({
        fieldLabel: 'Receipt Amount',
        id: 'txtRecAmt',
        width: 80,
        name: 'RecAmt'
    });

    var txtBankName = new Ext.form.TextField({
        fieldLabel: 'Party Bank',
        id: 'txtBankName',
        width: 200,
        name: 'BankName',
        style: {textTransform: "uppercase"},
        labelStyle : "font-size:14px;font-weight:bold;color:#0080ff",
        autoCreate:{tag:'input',type:'text',size:'20',autocomplete:'off',maxlength:'34'},
        listeners: {
            blur: function () {
                txtNarration.setValue(txtBankName.getValue().toUpperCase());
            }
        }
    });

    var cmbPaymode = new Ext.form.ComboBox({
        fieldLabel: 'Receipt Mode',
        width: 80,
        store: [[1, 'CHQ'], [2, 'DD'], [3,'NEFT'], [4, 'RTGS'], [5, 'IMPS'], [6, 'TRANSFER'], [7, 'ONLINE'], [8, 'UPI']],
        displayField: 'Paymode_id',
        valueField: 'Paymode_code',
        hiddenName: 'Paymode_id',
        id: 'cmbPaymode',
        typeAhead: true,
        mode: 'local',
        forceSelection: true,
        triggerAction: 'all',
        selectOnFocus: true,
        editable: false,
        allowblank: false,
        labelStyle : "font-size:14px;font-weight:bold;color:#0080ff",
    });

    var txtNo = new Ext.form.TextField({
        fieldLabel: 'No',
        id: 'txtNo',
        width: 60,
        name: 'No'
    });

    var dtpDate = new Ext.form.DateField({
        fieldLabel: 'Date',
        id: 'dtpDate',
        name: 'Date',
        format: 'd-m-Y',
        value: new Date(),
//value: '2020-03-31',
        anchor: '100%'
    });

    var lblAdjustingDoc = new Ext.form.Label({
        fieldLabel: 'Adjusting Document',
        id: 'lblAdjustingDoc',
        width: 50,
        labelStyle  : "font-size:14px;font-weight:bold;color:#fc9403",
    });



    function ClearAdjusted() {
		var selrows = flxAdjustDetails.getStore().getCount();
		for (var i = 0; i < selrows; i++) {
		    var rec = flxAdjustDetails.getStore().getAt(i);
		    if (rec.get('adjamt') == 0 && rec.get('cdamount') > 0) {
		        rec.set('cdvalue',0);
		        rec.set('cgstamount',0);
		        rec.set('sgstamount',0);
		        rec.set('igstamount',0);
		        rec.set('cdamount',0);
		    }
		}
                CalcSum();

    }    



    function UpdateAdjusted() {

        var sm = flxAdjustDetails.getSelectionModel();
        var selrow = sm.getSelected();
        var rownum = flxAdjustDetails.store.indexOf(selrow);
        var rcnt = flxAdjustDetails.getStore().getCount();
        for (var i = 0; i < rcnt; i++) {
            var rec = flxAdjustDetails.getStore().getAt(i);
            if ( Number(rec.get('cdamount')) > 0 && Number(rec.get('adjamt')) > 0)
            {  
                  var tadj = Number(rec.get('cdamount'))  + Number(rec.get('adjamt'));
                  var pendamount = Number(rec.get('pendingamt2'));

                     if (Number(tadj) > Number(pendamount)) 
                     {
//alert(Number(tadj));
                  rec.set('cdvalue', 0);
                  rec.set('cgstamount', 0);
                  rec.set('sgstamount', 0);
                  rec.set('igstamount', 0);
                  rec.set('cdamount', 0);


                     } 
                    
            }
        }

 

    }      



function loadCDDetails() {

        ClearAdjusted();
        var cashdisc_value  = 0;
        var cashdisc_cgst_amt = 0;
        var cashdisc_sgst_amt = 0;
        var cashdisc_igst_amt = 0;
        var cashdisc_amount = 0;

        var cashdisc_value_method1  = 0;
        var cashdisc_value_method2  = 0;

        var adjustedamount = 0;

        Ext.getCmp('chkremark').setValue(false);
        txtNarration.setRawValue("");

    var dt_coll = dtpRefDate.getValue();
    if (!dt_coll) return;

    var store = flxAdjustDetails.getStore();
    var rcnt = store.getCount();

    for (var i = 0; i < rcnt; i++) {
        var rec = store.getAt(i);

        if (gstPaytype == "BB" && rec.get('invdate')) {
            var invDate